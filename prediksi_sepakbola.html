<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HYBRID PRIME ENGINE – MERGE EDITION</title>
<style>
    body{
        background:#10131a; color:#d6d8df;
        font-family:Arial; padding:20px;
    }
    h1,h2{color:#5bd1ff;}
    .section{
        border:1px solid #2f3b53;
        padding:15px; margin-bottom:18px;
        border-radius:10px;
        background:#161b25;
    }
    .grid{
        display:grid;
        grid-template-columns:repeat(2,1fr);
        gap:10px;
    }
    input,select{
        width:100%; padding:6px;
        background:#0f1218; color:white;
        border:1px solid #3d4658;
        border-radius:5px;
    }
    button{
        padding:10px; background:#1f7aff;
        border:none; border-radius:6px;
        color:white; font-weight:bold;
        cursor:pointer; margin:5px 0;
    }
    button:hover{background:#3d8dff;}
    #outputBox{
        white-space:pre-line;
        background:#0f1218;
        padding:15px; min-height:200px;
        border-radius:10px; border:1px solid #32415c;
        overflow-y:auto;
    }
</style>
</head>
<body>

<h1>HYBRID PRIME ENGINE — MERGE EDITION</h1>
<p>(Gabungan Stabil + Akurat dari parlay_good (3) & parlay_god)</p>

<!-- =======================================================
     SECTION 1 — INPUT DASAR (GF/GA + ADV STATS)
======================================================= -->
<div class="section">
<h2>1. INPUT DASAR TIM</h2>
<div class="grid">

<div>
<label>Home GF</label>
<input id="h_gf" type="number">
</div>

<div>
<label>Home GA</label>
<input id="h_ga" type="number">
</div>

<div>
<label>Away GF</label>
<input id="a_gf" type="number">
</div>

<div>
<label>Away GA</label>
<input id="a_ga" type="number">
</div>

<div>
<label>Home xG</label>
<input id="adv_xg_home" type="number" step="0.01">
</div>

<div>
<label>Home xGA</label>
<input id="adv_xga_home" type="number" step="0.01">
</div>

<div>
<label>Away xG</label>
<input id="adv_xg_away" type="number" step="0.01">
</div>

<div>
<label>Away xGA</label>
<input id="adv_xga_away" type="number" step="0.01">
</div>

</div>
</div>


<!-- =======================================================
     SECTION 2 — FORM, MOMENTUM, STABILITY
======================================================= -->
<div class="section">
<h2>2. FORM – MOMENTUM – STABILITY</h2>
<div class="grid">

<div><label>Form Home W</label><input id="form_home_w" type="number"></div>
<div><label>Form Home D</label><input id="form_home_d" type="number"></div>
<div><label>Form Home L</label><input id="form_home_l" type="number"></div>

<div><label>Form Away W</label><input id="form_away_w" type="number"></div>
<div><label>Form Away D</label><input id="form_away_d" type="number"></div>
<div><label>Form Away L</label><input id="form_away_l" type="number"></div>

<div><label>Momentum Home (1–10)</label><input id="home_mom" type="number"></div>
<div><label>Momentum Away (1–10)</label><input id="away_mom" type="number"></div>

<div><label>Stability Home</label><input id="home_st" type="number"></div>
<div><label>Stability Away</label><input id="away_st" type="number"></div>

<div><label>Flexibility Home</label><input id="home_flex" type="number"></div>
<div><label>Flexibility Away</label><input id="away_flex" type="number"></div>

</div>
</div>


<!-- =======================================================
     SECTION 3 — PRESSING + PPDA
======================================================= -->
<div class="section">
<h2>3. PRESSING – PPDA – DEFENSIVE ERROR</h2>
<div class="grid">

<div>
<label>Pressing Style Home</label>
<select id="press_style_home">
    <option value="">– pilih –</option>
    <option value="extreme_high">Extreme High</option>
    <option value="gegenpress">Gegenpress</option>
    <option value="high_press">High Press</option>
    <option value="mid_press">Mid Press</option>
    <option value="midblock">Mid Block</option>
    <option value="low_block">Low Block</option>
</select>
</div>

<div>
<label>Pressing Style Away</label>
<select id="press_style_away">
    <option value="">– pilih –</option>
    <option value="extreme_high">Extreme High</option>
    <option value="gegenpress">Gegenpress</option>
    <option value="high_press">High Press</option>
    <option value="mid_press">Mid Press</option>
    <option value="midblock">Mid Block</option>
    <option value="low_block">Low Block</option>
</select>
</div>

<div>
<label>PPDA Home</label>
<input id="adv_ppda_home" type="number">
</div>

<div>
<label>PPDA Away</label>
<input id="adv_ppda_away" type="number">
</div>

<div>
<label>Error Defensif Home</label>
<input id="adv_err_home" type="number" step="0.01">
</div>

<div>
<label>Error Defensif Away</label>
<input id="adv_err_away" type="number" step="0.01">
</div>

</div>

<button id="btnAutoPPDA">AUTO PPDA EXTENDED</button>

</div>


<!-- =======================================================
     SECTION 4 — TEMPO, CHAOS, IMPORTANCE
======================================================= -->
<div class="section">
<h2>4. TEMPO – CHAOS – IMPORTANCE</h2>

<div class="grid">
<div><label>Tempo</label><input id="tempo_input" type="number"></div>
<div><label>Chaos</label><input id="chaos_input" type="number"></div>
<div><label>Importance</label><input id="importance_input" type="number"></div>
</div>

<button id="btnAutoTCI">AUTO TCI</button>

</div>


<!-- =======================================================
     SECTION 5 — TOMBOL ENGINE
======================================================= -->
<div class="section">
<h2>5. ENGINE – HYBRID MODULES</h2>

<button id="btnPrime">RUN PRIME ENGINE</button>
<button id="btnDifficulty">MATCH DIFFICULTY</button>
<button id="btnFlow">MATCH FLOW</button>
<button id="btnTrend">TEAM TREND</button>
<button id="btnSetPiece">SET PIECE POWER</button>

<button id="btnInfinity">INFINITY ENGINE</button>
<button id="btnGUN">GRAND UNIFIED ENGINE</button>

<button id="btnBRM">BRM SUITE</button>

</div>


<!-- =======================================================
     SECTION 6 — OUTPUT
======================================================= -->
<div class="section">
<h2>6. OUTPUT</h2>
<div id="outputBox"></div>
</div>
 <!-- ============================================
PART 1 – INPUT SYSTEM (FINAL CLEAN TEMPLATE)
=============================================== -->

<script>
// Global PSZ namespace (jangan diubah)
window.PSZ = {
    state : {},
    log : function(msg){
        const el = document.getElementById("output");
        if(el) el.value += msg + "\n";
    },
    el  : function(id){return document.getElementById(id);},
    num : function(id, def){
        const el = document.getElementById(id);
        if(!el) return def;
        const v = parseFloat(el.value);
        return isNaN(v) ? def : v;
    }
};

// ===============================
//  INPUT VALIDATOR (clean)
// ===============================
PSZ.validateInput = function(){
    const required = [
        "adv_xg_home","adv_xg_away",
        "adv_xga_home","adv_xga_away",
        "adv_err_home","adv_err_away"
    ];

    required.forEach(id=>{
        const el = PSZ.el(id);
        if(el && el.value.trim()===""){
            el.style.background = "#ffdad6";  // highlight merah lembut
        } else if(el){
            el.style.background = "";
        }
    });

    PSZ.log("Validator: Input dicek.");
};


// ===============================
// PRESSING PRESET → PPDA MAP
// ===============================
PSZ.pressingPresetToPPDA = function(style){

    switch(style){
        case "extreme_high": return 4.5;
        case "gegenpress":   return 6.5;
        case "high":         return 8.5;
        case "mid":          return 10.5;
        case "mid_low":      return 12.5;
        case "low":          return 15.5;
        default:             return 11.0;
    }
};


// =============================================
// AUTO PPDA EXTENDED v2
// Menggunakan: gaya pressing + xGA + error rate
// =============================================
PSZ.autoPPDA = function(){

    const ph = PSZ.el("press_home")?.value || "";
    const pa = PSZ.el("press_away")?.value || "";

    let ppdaH = PSZ.pressingPresetToPPDA(ph);
    let ppdaA = PSZ.pressingPresetToPPDA(pa);

    const xgaH = PSZ.num("adv_xga_home",1.3);
    const xgaA = PSZ.num("adv_xga_away",1.3);

    const errH = PSZ.num("adv_err_home",0.10);
    const errA = PSZ.num("adv_err_away",0.10);

    // Koreksi berdasarkan xGA (pressing tinggi → xGA rendah)
    ppdaH += (xgaH - 1.2) * 2.5;
    ppdaA += (xgaA - 1.2) * 2.5;

    // Koreksi error defensif (error tinggi = PPDA naik = pressing buruk)
    ppdaH += errH * 12;
    ppdaA += errA * 12;

    ppdaH = Math.max(4, Math.min(20, ppdaH));
    ppdaA = Math.max(4, Math.min(20, ppdaA));

    PSZ.el("adv_ppda_home").value = ppdaH.toFixed(2);
    PSZ.el("adv_ppda_away").value = ppdaA.toFixed(2);

    PSZ.state.home_press = ppdaH;
    PSZ.state.away_press = ppdaA;

    PSZ.log("Auto-PPDA dijalankan.");
};


// =============================================
// AUTO TCI (Tempo / Chaos / Importance)
// =============================================
PSZ.autoTCI = function(){

    const matchType = PSZ.el("match_type")?.value || "";

    let tempo = 5, chaos = 5, imp = 5;

    switch(matchType){
        case "league":
            tempo = 5; chaos = 5; imp = 5;
            break;
        case "derby":
            tempo = 7; chaos = 7; imp = 6;
            break;
        case "cup":
            tempo = 6; chaos = 6; imp = 7;
            break;
        case "final":
            tempo = 5; chaos = 4; imp = 9;
            break;
        case "relegation":
            tempo = 4; chaos = 5; imp = 8;
            break;
        case "friendly":
            tempo = 6; chaos = 7; imp = 3;
            break;
    }

    PSZ.el("tempo_input").value      = tempo;
    PSZ.el("chaos_input").value      = chaos;
    PSZ.el("importance_input").value = imp;

    PSZ.log("Auto TCI di-set berdasarkan match type.");
};


// =============================================
// BIND TOMBOL PART 1
// =============================================
PSZ.el("btnValidate").onclick = ()=> PSZ.validateInput();
PSZ.el("btnAutoPPDA").onclick = ()=> PSZ.autoPPDA();
PSZ.el("btnTCI").onclick      = ()=> PSZ.autoTCI();

PSZ.log("PART 1 Loaded: Input + AutoPPDA + Validator + TCI OK.");

</script>
<!-- ============================================
PART 2 – LAMBDA ENGINE (FINAL CLEAN VERSION)
=============================================== -->

<script>
// ==================================================
// LAMBDA ENGINE — Fondasi seluruh model prediksi
// ==================================================
PSZ.runLambda = function(){

    PSZ.log("=== LAMBDA ENGINE (FINAL CLEAN) ===");

    // ----------------------------------
    // Ambil data dasar (xG, xGA)
    // ----------------------------------
    const xgH  = PSZ.num("adv_xg_home" ,1.40);
    const xgA  = PSZ.num("adv_xg_away" ,1.40);
    const xgaH = PSZ.num("adv_xga_home",1.40);
    const xgaA = PSZ.num("adv_xga_away",1.40);

    // ----------------------------------
    // Pressing & PPDA
    // ----------------------------------
    const ppdaH = PSZ.num("adv_ppda_home",12);
    const ppdaA = PSZ.num("adv_ppda_away",12);

    // Konversi PPDA → Pressing Impact 0–10
    function pressImpact(ppda){
        return Math.max(0, Math.min(10, 12 - (ppda * 0.55)));
    }

    const pressH = pressImpact(ppdaH);
    const pressA = pressImpact(ppdaA);

    // Simpan state pressing
    PSZ.state.pressH = pressH;
    PSZ.state.pressA = pressA;

    // ----------------------------------
    // Defensive Error & Stability
    // ----------------------------------
    const errH = PSZ.num("adv_err_home",0.10);
    const errA = PSZ.num("adv_err_away",0.10);

    const stH = PSZ.num("home_st",5);
    const stA = PSZ.num("away_st",5);

    const flexH = PSZ.num("home_flex",5);
    const flexA = PSZ.num("away_flex",5);

    // ----------------------------------
    // TCI (Tempo / Chaos / Importance)
    // ----------------------------------
    const tempo = PSZ.num("tempo_input",5);
    const chaos = PSZ.num("chaos_input",5);
    const imp   = PSZ.num("importance_input",5);

    // ----------------------------------
    // LANGKAH 1: Base Lambda (xG vs xGA)
    // ----------------------------------
    let lambdaH = (xgH + (xgaA*0.25));
    let lambdaA = (xgA + (xgaH*0.25));

    // ----------------------------------
    // LANGKAH 2: Pressing Effect
    // ----------------------------------
    lambdaH *= (1 + (pressH - 5) * 0.030);
    lambdaA *= (1 + (pressA - 5) * 0.030);

    // ----------------------------------
    // LANGKAH 3: Tempo & Chaos
    // ----------------------------------
    lambdaH *= (1 + (tempo - 5) * 0.020 + (chaos - 5) * 0.015);
    lambdaA *= (1 + (tempo - 5) * 0.020 + (chaos - 5) * 0.015);

    // ----------------------------------
    // LANGKAH 4: Importance (laga penting biasanya lebih hati-hati)
    // ----------------------------------
    lambdaH *= (1 + (imp - 5) * -0.015);
    lambdaA *= (1 + (imp - 5) * -0.015);

    // ----------------------------------
    // LANGKAH 5: Defensive Error
    // ----------------------------------
    lambdaH *= (1 + errA * 0.30);
    lambdaA *= (1 + errH * 0.30);

    // ----------------------------------
    // LANGKAH 6: Stability & Flexibility
    // ----------------------------------
    lambdaH *= (1 + (flexH - 5)*0.010 + (stH - 5)*0.008);
    lambdaA *= (1 + (flexA - 5)*0.010 + (stA - 5)*0.008);

    // ----------------------------------
    // LANGKAH 7: Momentum Drift
    // ----------------------------------
    const drift = (tempo + chaos)/24; // 0.3–0.8
    lambdaH *= (1 + drift*0.06);
    lambdaA *= (1 + drift*0.06);

    // ----------------------------------
    // FINAL PROTECTION (Batas aman)
    // ----------------------------------
    lambdaH = Math.max(0.15, Math.min(4.50, lambdaH));
    lambdaA = Math.max(0.15, Math.min(4.50, lambdaA));

    // SIMPAN
    PSZ.state.lambdaH = lambdaH;
    PSZ.state.lambdaA = lambdaA;

    // OUTPUT
    PSZ.log(`λ Home = ${lambdaH.toFixed(3)}`);
    PSZ.log(`λ Away = ${lambdaA.toFixed(3)}`);
    PSZ.log("Lambda Engine selesai.");
};


// =============================================
// TOMBOL PART 2
// =============================================
PSZ.el("btnLambda").onclick = ()=> PSZ.runLambda();

</script>
<!-- ============================================
PART 3 – PRIME ENGINE (FINAL CLEAN VERSION)
=============================================== -->

<script>
// ==========================================================
// PRIME ENGINE = MODEL POISSON PREDIKSI SKOR
// ==========================================================

PSZ.runPrime = function(){

    PSZ.log("=== PRIME ENGINE (Poisson Model – Final Clean) ===");

    // Ambil lambda yang dihitung Part 2
    const λH = PSZ.state.lambdaH || 1.25;
    const λA = PSZ.state.lambdaA || 1.25;

    PSZ.state.prime = {};
    PSZ.state.prime.matrix = [];

    // ==============================
    // Fungsi Poisson
    // ==============================
    function pois(k, lambda){
        return Math.exp(-lambda) * Math.pow(lambda, k) / factorial(k);
    }

    function factorial(n){
        let r = 1;
        for(let i=2;i<=n;i++) r*=i;
        return r;
    }

    // ==============================
    // HITUNG PROBABILITAS SKOR 0–6
    // ==============================
    let matrix = [];
    let sumHomeWin = 0;
    let sumDraw     = 0;
    let sumAwayWin = 0;

    let totalOver25 = 0;
    let totalUnder25 = 0;

    for(let h=0; h<=6; h++){
        matrix[h] = [];
        for(let a=0; a<=6; a++){

            const pH = pois(h, λH);
            const pA = pois(a, λA);
            const p  = pH * pA;

            matrix[h][a] = p;

            // 1X2
            if(h > a) sumHomeWin += p;
            else if(h === a) sumDraw += p;
            else sumAwayWin += p;

            // O/U 2.5
            if(h + a > 2.5) totalOver25 += p;
            else            totalUnder25 += p;
        }
    }

    // Simpan
    PSZ.state.prime.matrix  = matrix;
    PSZ.state.prime.HW      = sumHomeWin;
    PSZ.state.prime.D       = sumDraw;
    PSZ.state.prime.AW      = sumAwayWin;
    PSZ.state.prime.OU25    = {over: totalOver25, under: totalUnder25};

    // ==============================
    // OUTPUT
    // ==============================
    PSZ.log("λ Home = " + λH.toFixed(3));
    PSZ.log("λ Away = " + λA.toFixed(3));

    PSZ.log("*** Probabilitas 1X2 (Prime) ***");
    PSZ.log("Home Win : " + (sumHomeWin*100).toFixed(2) + "%");
    PSZ.log("Draw     : " + (sumDraw*100).toFixed(2) + "%");
    PSZ.log("Away Win : " + (sumAwayWin*100).toFixed(2) + "%");

    PSZ.log("*** Over/Under 2.5 ***");
    PSZ.log("Over 2.5 : " + (totalOver25*100).toFixed(2) + "%");
    PSZ.log("Under 2.5: " + (totalUnder25*100).toFixed(2) + "%");

    PSZ.log("Prime Engine selesai.");
};


// ==========================================================
// TOMBOL PART 3
// ==========================================================
PSZ.el("btnPrime").onclick = ()=> PSZ.runPrime();

</script>
<!-- ============================================
PART 4 – ADVANCED ENGINE (FINAL CLEAN VERSION)
=============================================== -->

<script>
// ==========================================================
// ADVANCED ENGINE
//  - Chaos Reality
//  - Swing Reality
//  - Hybrid Merge (Prime + Chaos + Swing)
// ==========================================================

PSZ.runAdvanced = function(){

    PSZ.log("=== ADVANCED ENGINE (Chaos + Swing + Hybrid) ===");

    // Pastikan lambda & Prime sudah ada
    if(!PSZ.state.lambdaH || !PSZ.state.lambdaA){
        PSZ.log("Lambda belum ada, menjalankan Lambda Engine...");
        PSZ.runLambda();
    }
    if(!PSZ.state.prime){
        PSZ.log("Prime belum ada, menjalankan Prime Engine...");
        PSZ.runPrime();
    }

    const λH = PSZ.state.lambdaH;
    const λA = PSZ.state.lambdaA;

    const tempo = PSZ.num("tempo_input",5);
    const chaos = PSZ.num("chaos_input",5);

    const momH  = PSZ.num("home_mom",5);
    const momA  = PSZ.num("away_mom",5);
    const stH   = PSZ.num("home_st",5);
    const stA   = PSZ.num("away_st",5);
    const flexH = PSZ.num("home_flex",5);
    const flexA = PSZ.num("away_flex",5);

    // Helper Poisson
    function factorial(n){
        let r=1; for(let i=2;i<=n;i++) r*=i; return r;
    }
    function pois(k, lambda){
        return Math.exp(-lambda) * Math.pow(lambda,k) / factorial(k);
    }

    // --------------------------------------------------
    // 1) CHAOS REALITY
    // --------------------------------------------------
    const chaosFactor = 1 + (chaos - 5) * 0.12;    // 4 → -, 6+ → +
    const λH_chaos = λH * chaosFactor;
    const λA_chaos = λA * chaosFactor;

    let ch_H=0, ch_D=0, ch_A=0;

    for(let h=0; h<=6; h++){
        for(let a=0; a<=6; a++){
            const p = pois(h, λH_chaos) * pois(a, λA_chaos);
            if(h > a) ch_H += p;
            else if(h === a) ch_D += p;
            else ch_A += p;
        }
    }

    const chaosReality = {H:ch_H, D:ch_D, A:ch_A};
    PSZ.state.chaosReality = chaosReality;

    // --------------------------------------------------
    // 2) SWING REALITY (Momentum + Stability + Flex)
    // --------------------------------------------------
    const swingH = momH*0.25 + flexH*0.20 - stH*0.15;
    const swingA = momA*0.25 + flexA*0.20 - stA*0.15;

    const λH_swing = λH * (1 + swingH*0.06);
    const λA_swing = λA * (1 + swingA*0.06);

    let sw_H=0, sw_D=0, sw_A=0;

    for(let h=0; h<=6; h++){
        for(let a=0; a<=6; a++){
            const p = pois(h, λH_swing) * pois(a, λA_swing);
            if(h > a) sw_H += p;
            else if(h === a) sw_D += p;
            else sw_A += p;
        }
    }

    const swingReality = {H:sw_H, D:sw_D, A:sw_A};
    PSZ.state.swingReality = swingReality;

    // --------------------------------------------------
    // 3) MERGE PRIME + CHAOS + SWING
    // --------------------------------------------------
    const prime = PSZ.state.prime;

    const pH = prime.HW;
    const pD = prime.D;
    const pA = prime.AW;

    // Bobot bisa disesuaikan, ini setting aman & stabil
    const wPrime = 0.55;
    const wChaos = 0.25;
    const wSwing = 0.20;

    const finalH = pH*wPrime + chaosReality.H*wChaos + swingReality.H*wSwing;
    const finalD = pD*wPrime + chaosReality.D*wChaos + swingReality.D*wSwing;
    const finalA = pA*wPrime + chaosReality.A*wChaos + swingReality.A*wSwing;

    const hybrid = {H:finalH, D:finalD, A:finalA};
    PSZ.state.hybrid = hybrid;

    // --------------------------------------------------
    // OUTPUT
    // --------------------------------------------------
    PSZ.log("*** Chaos Reality (1X2) ***");
    PSZ.log("Home : " + (chaosReality.H*100).toFixed(2) + "%");
    PSZ.log("Draw : " + (chaosReality.D*100).toFixed(2) + "%");
    PSZ.log("Away : " + (chaosReality.A*100).toFixed(2) + "%");

    PSZ.log("*** Swing Reality (1X2) ***");
    PSZ.log("Home : " + (swingReality.H*100).toFixed(2) + "%");
    PSZ.log("Draw : " + (swingReality.D*100).toFixed(2) + "%");
    PSZ.log("Away : " + (swingReality.A*100).toFixed(2) + "%");

    PSZ.log("*** HYBRID (Prime + Chaos + Swing) ***");
    PSZ.log("Home : " + (finalH*100).toFixed(2) + "%");
    PSZ.log("Draw : " + (finalD*100).toFixed(2) + "%");
    PSZ.log("Away : " + (finalA*100).toFixed(2) + "%");

    PSZ.log("Advanced Engine selesai.");
};

</script>
  <!-- ============================================
PART 5 – INFINITY ENGINE (FINAL CLEAN VERSION)
=============================================== -->

<script>
// ==========================================================
// INFINITY ENGINE
//  - Hybrid (Prime + Advanced Merge)
//  - Monte Carlo Simulation
//  - GUN (Grand Unified Numbers)
// ==========================================================

PSZ.runInfinity = function(){

    PSZ.log("=== INFINITY ENGINE START ===");

    // Pastikan ada lambda, prime, advanced/hybrid
    if(!PSZ.state.lambdaH) PSZ.runLambda();
    if(!PSZ.state.prime)   PSZ.runPrime();
    if(!PSZ.state.hybrid)  PSZ.runAdvanced();

    const λH = PSZ.state.lambdaH;
    const λA = PSZ.state.lambdaA;

    // =========================================
    // 1. MONTE CARLO (10k iteration)
    // =========================================
    const ITER = 10000;

    let hw = 0, dr = 0, aw = 0;
    let over25 = 0;

    function randPoisson(lambda){
        // Knuth method (ringan, stabil)
        let L = Math.exp(-lambda);
        let k = 0;
        let p = 1;
        do{
            k++;
            p *= Math.random();
        } while(p > L);
        return k - 1;
    }

    for(let i=0; i<ITER; i++){
        const h = randPoisson(λH);
        const a = randPoisson(λA);

        if(h > a) hw++;
        else if(h === a) dr++;
        else aw++;

        if(h + a > 2.5) over25++;
    }

    const mcH  = hw/ITER;
    const mcD  = dr/ITER;
    const mcA  = aw/ITER;
    const mcOv = over25/ITER;

    PSZ.state.mc = {H:mcH, D:mcD, A:mcA, O25:mcOv};

    // =========================================
    // 2. INFINITY BLEND
    //    Prime + Hybrid + MC
    // =========================================
    const prime  = PSZ.state.prime;
    const hybrid = PSZ.state.hybrid;

    const wPrime  = 0.35;
    const wHybrid = 0.35;
    const wMC     = 0.30;

    const infH = prime.HW*wPrime + hybrid.H*wHybrid + mcH*wMC;
    const infD = prime.D*wPrime  + hybrid.D*wHybrid + mcD*wMC;
    const infA = prime.AW*wPrime + hybrid.A*wHybrid + mcA*wMC;

    const infOver = prime.OU25.over*0.45 + mcOv*0.55;

    // SIMPAN
    PSZ.state.infinity = {
        H:infH, D:infD, A:infA, OVER:infOver
    };

    // =========================================
    // 3. GUN – GRAND UNIFIED NUMBERS
    // =========================================
    const gun_side_gap  = (infH - infA) * 100;   // positive → Home condong
    const gun_goal_bias = (infOver - 0.50) * 100;
    const gun_drawness  = infD * 100;

    PSZ.state.gun = {
        side_gap  : gun_side_gap,
        goal_bias : gun_goal_bias,
        drawness  : gun_drawness
    };

    // =========================================
    // OUTPUT
    // =========================================
    PSZ.log("*** Infinity Engine (Unified Probabilities) ***");
    PSZ.log("Home : " + (infH*100).toFixed(2) + "%");
    PSZ.log("Draw : " + (infD*100).toFixed(2) + "%");
    PSZ.log("Away : " + (infA*100).toFixed(2) + "%");

    PSZ.log("*** Over/Under 2.5 (Infinity) ***");
    PSZ.log("Over 2.5 : " + (infOver*100).toFixed(2) + "%");
    PSZ.log("Under 2.5: " + ((1-infOver)*100).toFixed(2) + "%");

    PSZ.log("*** GUN – Grand Unified Numbers ***");
    PSZ.log("Side Gap  : " + gun_side_gap.toFixed(2));
    PSZ.log("Goal Bias : " + gun_goal_bias.toFixed(2));
    PSZ.log("Drawness  : " + gun_drawness.toFixed(2));

    PSZ.log("=== INFINITY ENGINE DONE ===");
};


// =============================================
// TOMBOL PART 5
// =============================================
PSZ.el("btnInfinity").onclick = ()=> PSZ.runInfinity();
PSZ.el("btnGUN").onclick       = ()=> {
    if(!PSZ.state.infinity) PSZ.runInfinity();
    PSZ.log("GUN Side Gap  : " + PSZ.state.gun.side_gap.toFixed(2));
    PSZ.log("GUN Goal Bias : " + PSZ.state.gun.goal_bias.toFixed(2));
    PSZ.log("GUN Drawness  : " + PSZ.state.gun.drawness.toFixed(2));
};

</script>
<!-- ============================================
PART 6 – ANALYTICS (FINAL CLEAN VERSION)
=============================================== -->

<script>
// ========================================================
// 1) MATCH DIFFICULTY RATING
// ========================================================
PSZ.runDifficulty = function(){

    PSZ.log("=== MATCH DIFFICULTY RATING ===");

    const sideGap = (PSZ.state.infinity?.H || 0) - (PSZ.state.infinity?.A || 0);
    const drawness = (PSZ.state.infinity?.D || 0);

    const tempo = PSZ.num("tempo_input",5);
    const chaos = PSZ.num("chaos_input",5);
    const imp   = PSZ.num("importance_input",5);

    // Perhitungan difficulty dasar
    let diff = 50;

    diff += Math.abs(sideGap)*25;   // gap besar → laga berat
    diff += chaos*2;                // chaos menambah ketidakpastian
    diff += (10-imp)*1.5;           // match low importance → unpredictable

    diff = Math.max(20, Math.min(95, diff));

    PSZ.state.difficulty = diff;

    let label =
        diff >= 80 ? "Sangat Sulit / High Variance" :
        diff >= 65 ? "Sulit" :
        diff >= 50 ? "Sedang" :
        diff >= 35 ? "Cenderung Mudah":
                     "Mudah & Stabil";

    PSZ.log("Difficulty Value : " + diff.toFixed(1));
    PSZ.log("Kategori         : " + label);
};


// ========================================================
// 2) MATCH FLOW ENGINE
// ========================================================
PSZ.runFlow = function(){

    PSZ.log("=== MATCH FLOW ENGINE ===");

    const tempo = PSZ.num("tempo_input",5);
    const chaos = PSZ.num("chaos_input",5);
    const pressH = PSZ.state.pressH || 5;
    const pressA = PSZ.state.pressA || 5;

    // Flow score
    const flow = 
        tempo*0.45 +
        chaos*0.35 +
        ((10-pressH)+(10-pressA))*0.10;

    let label =
        flow >= 7.5 ? "Open Game (banyak peluang)" :
        flow >= 6.0 ? "Cukup Terbuka" :
        flow >= 4.5 ? "Seimbang / Normal":
        flow >= 3.0 ? "Relatif Tertutup" : 
                      "Low Tempo / Low Chance";

    PSZ.state.flow = flow;

    PSZ.log("Flow Score : " + flow.toFixed(2));
    PSZ.log("Interpretasi : " + label);
};


// ========================================================
// 3) TEAM TREND ANALYZER
// ========================================================
PSZ.runTrend = function(){

    PSZ.log("=== TEAM TREND ANALYZER ===");

    const momH  = PSZ.num("home_mom",5);
    const momA  = PSZ.num("away_mom",5);
    const stH   = PSZ.num("home_st",5);
    const stA   = PSZ.num("away_st",5);

    const trendH = momH*0.6 + stH*0.4;
    const trendA = momA*0.6 + stA*0.4;

    PSZ.state.trend = {trendH, trendA};

    let lH =
        trendH >= 7 ? "Sangat Bagus":
        trendH >= 6 ? "Positif":
        trendH >= 5 ? "Normal":
        trendH >= 4 ? "Menurun":
                      "Buruk";

    let lA =
        trendA >= 7 ? "Sangat Bagus":
        trendA >= 6 ? "Positif":
        trendA >= 5 ? "Normal":
        trendA >= 4 ? "Menurun":
                      "Buruk";

    PSZ.log("Trend Home : "+trendH.toFixed(1)+" → "+lH);
    PSZ.log("Trend Away : "+trendA.toFixed(1)+" → "+lA);
};


// ========================================================
// 4) SET PIECE POWER INDEX
// ========================================================
PSZ.runSetPiece = function(){

    PSZ.log("=== SET PIECE POWER INDEX ===");

    const stH = PSZ.num("home_st",5);
    const stA = PSZ.num("away_st",5);
    const flexH = PSZ.num("home_flex",5);
    const flexA = PSZ.num("away_flex",5);

    const sppH = stH*1.2 + flexH*0.6;
    const sppA = stA*1.2 + flexA*0.6;

    PSZ.state.setpiece = {H:sppH, A:sppA};

    PSZ.log("SPP Home : " + sppH.toFixed(1));
    PSZ.log("SPP Away : " + sppA.toFixed(1));

    if(Math.abs(sppH - sppA) < 1)
        PSZ.log("Duel set piece relatif imbang.");
    else if(sppH > sppA)
        PSZ.log("Home sedikit lebih berbahaya di set piece.");
    else
        PSZ.log("Away sedikit lebih berbahaya di set piece.");
};


// ========================================================
// 5) BRM SUITE (Betting Risk Model)
// ========================================================
PSZ.runBRM = function(){

    PSZ.log("=== BRM SUITE (Betting Risk Management) ===");

    if(!PSZ.state.infinity) PSZ.runInfinity();

    const pH = PSZ.state.infinity.H;
    const pD = PSZ.state.infinity.D;
    const pA = PSZ.state.infinity.A;

    const over = PSZ.state.infinity.OVER;

    const sideGap = pH - pA;
    const goalBias = over - 0.50;

    let sideFocus = "None";
    let overFocus = "Neutral";

    // SIDE
    if(Math.abs(sideGap) < 0.03){
        sideFocus = "Tidak ada kecondongan pasaran";
    } else if(sideGap > 0){
        sideFocus = "Condong HOME";
    } else {
        sideFocus = "Condong AWAY";
    }

    // GOALS
    if(goalBias > 0.10) overFocus = "OVER strongly";
    else if(goalBias > 0.03) overFocus = "OVER slight";
    else if(goalBias < -0.10) overFocus = "UNDER strongly";
    else if(goalBias < -0.03) overFocus = "UNDER slight";
    else overFocus = "Neutral";

    // Difficulty → Risk classification
    const diff = PSZ.state.difficulty || 55;

    let risk =
        diff >= 80 ? "High Risk / Variance Tinggi":
        diff >= 65 ? "Medium High Risk":
        diff >= 50 ? "Normal":
        diff >= 35 ? "Low Risk":
                     "Very Low Risk";

    PSZ.state.brm = {
        side: sideFocus,
        total: overFocus,
        risk
    };

    PSZ.log("Side Edge : " + sideFocus);
    PSZ.log("Goal Edge : " + overFocus);
    PSZ.log("Risk Level: " + risk);
};


// ========================================================
// BIND TOMBOL PART 6
// ========================================================
PSZ.el("btnDifficulty").onclick = ()=> PSZ.runDifficulty();
PSZ.el("btnFlow").onclick       = ()=> PSZ.runFlow();
PSZ.el("btnTrend").onclick      = ()=> PSZ.runTrend();
PSZ.el("btnSetPiece").onclick   = ()=> PSZ.runSetPiece();
PSZ.el("btnBRM").onclick        = ()=> PSZ.runBRM();

</script>
  <!-- ============================================
PART 7 – PRO MODULES (FINAL CLEAN VERSION)
DIM + TCA + PIM v2 + xT-lite
=============================================== -->

<script>
// Helper: parse formasi "4-3-3" dst (aman kalau kosong)
PSZ.parseFormation = function(f){
    if(!f) return {def:0,mid:0,att:0,extra:0};
    const parts = f.split("-")
        .map(x=>parseInt(x.trim(),10))
        .filter(x=>!isNaN(x));
    return {
        def: parts[0] || 0,
        mid: parts[1] || 0,
        att: parts[2] || 0,
        extra: parts[3] || 0
    };
};

// ==================================================
// 1) DIM – DEFENSIVE INTEGRITY MODEL
// ==================================================
PSZ.runDIM = function(){

    PSZ.log("=== DEFENSIVE INTEGRITY MODEL (DIM) ===");

    const ppdaH = PSZ.num("adv_ppda_home",12);
    const ppdaA = PSZ.num("adv_ppda_away",12);

    const errH  = PSZ.num("adv_err_home",0.10);
    const errA  = PSZ.num("adv_err_away",0.10);

    const xgaH  = PSZ.num("adv_xga_home",1.40);
    const xgaA  = PSZ.num("adv_xga_away",1.40);

    const stH   = PSZ.num("home_st",5);
    const stA   = PSZ.num("away_st",5);

    const flexH = PSZ.num("home_flex",5);
    const flexA = PSZ.num("away_flex",5);

    // Defensive Wall Rating (semakin tinggi, semakin kokoh)
    const dwrH = 60
        - (ppdaH-10)*1.2
        - (xgaH-1.2)*8
        - errH*40
        + stH*2.2
        + flexH*1.0;

    const dwrA = 60
        - (ppdaA-10)*1.2
        - (xgaA-1.2)*8
        - errA*40
        + stA*2.2
        + flexA*1.0;

    // Expected Concession Suppression (perubahan % dari rata-rata)
    const ecsH = (dwrH - 50) * 0.8;
    const ecsA = (dwrA - 50) * 0.8;

    PSZ.state.dim = {dwrH,dwrA,ecsH,ecsA};

    function labelDWR(v){
        if(v >= 65) return "Sangat Kokoh";
        if(v >= 55) return "Cukup Solid";
        if(v >= 45) return "Normal";
        if(v >= 35) return "Rentan";
        return "Sangat Rapuh";
    }

    PSZ.log(`DWR Home: ${dwrH.toFixed(1)} → ${labelDWR(dwrH)}`);
    PSZ.log(`DWR Away: ${dwrA.toFixed(1)} → ${labelDWR(dwrA)}`);
    PSZ.log(`ECS Home: ${ecsH.toFixed(1)}% (penyesuaian kebobolan)`);
    PSZ.log(`ECS Away: ${ecsA.toFixed(1)}%`);
};


// ==================================================
// 2) TCA – TACTICAL CLASH ANALYZER
// ==================================================
PSZ.runTCA = function(){

    PSZ.log("=== TACTICAL CLASH ANALYZER (TCA) ===");

    const fH = PSZ.parseFormation((PSZ.el("formation_home")?.value || "").trim());
    const fA = PSZ.parseFormation((PSZ.el("formation_away")?.value || "").trim());

    const styleH = (PSZ.el("style_home")?.value || "");
    const styleA = (PSZ.el("style_away")?.value || "");
    const mType  = (PSZ.el("match_type")?.value || "");

    const notes = [];

    // Backline clash
    if(fH.def === 3 && fA.def === 4){
        notes.push("Home back 3 vs Away back 4 → potensi overload sayap untuk Home, tapi rawan halfspace.");
    }
    if(fH.def === 4 && fA.def === 3){
        notes.push("Away back 3 vs Home back 4 → wingback Away bisa 2v1 di sisi.");
    }
    if(fH.def === 5 || fA.def === 5){
        notes.push("Salah satu tim memakai back 5 → cenderung under & crossing heavy.");
    }

    // Midfield density
    if(fH.mid >= 4 && fA.mid <= 3){
        notes.push("Kepadatan tengah condong ke Home → kontrol midfield lebih kuat.");
    } else if(fA.mid >= 4 && fH.mid <= 3){
        notes.push("Kepadatan tengah condong ke Away → kontrol midfield lebih kuat.");
    }

    // Attacking line
    if(fH.att >= 3 && fA.att <= 2){
        notes.push("Home punya lebih banyak pemain depan → ancaman di kotak lebih besar.");
    } else if(fA.att >= 3 && fH.att <= 2){
        notes.push("Away punya lebih banyak pemain depan → ancaman di kotak lebih besar.");
    }

    // Style vs Style
    if(styleH === "possession" && styleA === "direct"){
        notes.push("Home possession vs Away direct → Home dominan bola, Away berbahaya di transisi.");
    }
    if(styleH === "transition" && styleA === "low_block"){
        notes.push("Home transisi vs low block Away → butuh gol awal, jika tidak bisa buntu.");
    }
    if(styleH === "high_press" || styleA === "high_press"){
        notes.push("High press salah satu tim → potensi error build-up & gol dari pressing.");
    }

    // Match type narrative
    if(mType === "derby"){
        notes.push("Derby match → emosi tinggi, risiko kartu & chaos meningkat.");
    } else if(mType === "cup"){
        notes.push("Cup / Knockout → rotasi & manajemen energi penting.");
    } else if(mType === "final"){
        notes.push("Final → intensitas tinggi, tapi sering hati-hati terutama babak pertama.");
    } else if(mType === "relegation"){
        notes.push("Relegation battle → tekanan mental tinggi, error individu bisa meningkat.");
    } else if(mType === "friendly"){
        notes.push("Friendly → intensitas rendah, rotasi besar, chaos menit akhir bisa tinggi.");
    }

    if(notes.length === 0){
        PSZ.log("Formasi/gaya/jenis match belum lengkap → TCA hanya mode minimal. Isi formasi & gaya untuk insight taktis.");
    } else {
        notes.forEach((n,i)=> PSZ.log((i+1)+". "+n));
    }
};


// ==================================================
// 3) PIM v2 – PRESSING INTENSITY MODEL
// ==================================================
PSZ.runPIM = function(){

    PSZ.log("=== PRESSING INTENSITY MODEL v2 (PIM) ===");

    const ppdaH = PSZ.num("adv_ppda_home",12);
    const ppdaA = PSZ.num("adv_ppda_away",12);

    const chaos = PSZ.num("chaos_input",5);
    const tempo = PSZ.num("tempo_input",5);

    const errH  = PSZ.num("adv_err_home",0.10);
    const errA  = PSZ.num("adv_err_away",0.10);

    // Konversi PPDA → base pressing 0–10
    const baseH = Math.max(0, Math.min(10, 12 - ppdaH/2));
    const baseA = Math.max(0, Math.min(10, 12 - ppdaA/2));

    function clamp(x){ return Math.max(0, Math.min(10,x)); }

    const earlyH = clamp(baseH + (tempo-5)*0.2 + (chaos-5)*0.1);
    const midH   = clamp(baseH - 0.8 + (chaos-5)*0.15);
    const lateH  = clamp(baseH - 1.2 + errH*10 + (chaos-5)*0.25);

    const earlyA = clamp(baseA + (tempo-5)*0.2 + (chaos-5)*0.1);
    const midA   = clamp(baseA - 0.8 + (chaos-5)*0.15);
    const lateA  = clamp(baseA - 1.2 + errA*10 + (chaos-5)*0.25);

    PSZ.log("Base Pressing Home: " + baseH.toFixed(2));
    PSZ.log("Base Pressing Away: " + baseA.toFixed(2));

    PSZ.log("Home Press Pattern:");
    PSZ.log("  Early (0–20) : " + earlyH.toFixed(1));
    PSZ.log("  Mid   (20–70): " + midH.toFixed(1));
    PSZ.log("  Late  (70+)  : " + lateH.toFixed(1));

    PSZ.log("Away Press Pattern:");
    PSZ.log("  Early (0–20) : " + earlyA.toFixed(1));
    PSZ.log("  Mid   (20–70): " + midA.toFixed(1));
    PSZ.log("  Late  (70+)  : " + lateA.toFixed(1));
};


// ==================================================
// 4) xT-lite – EXPECTED THREAT LITE
// ==================================================
PSZ.runXT = function(){

    PSZ.log("=== EXPECTED THREAT (xT-lite) ===");

    const xgH   = PSZ.num("adv_xg_home",1.40);
    const xgA   = PSZ.num("adv_xg_away",1.40);

    const tempo = PSZ.num("tempo_input",5);
    const chaos = PSZ.num("chaos_input",5);

    const pressH = PSZ.state.pressH || 5;
    const pressA = PSZ.state.pressA || 5;

    const styleH = (PSZ.el("style_home")?.value || "");
    const styleA = (PSZ.el("style_away")?.value || "");

    // Base xT ≈ xG dengan koreksi tempo/pressing/chaos
    let xT_H = xgH * (1 + (tempo-5)*0.06 + (10-pressH)*0.04 + (chaos-5)*0.03);
    let xT_A = xgA * (1 + (tempo-5)*0.06 + (10-pressA)*0.04 + (chaos-5)*0.03);

    // Style adjustment
    function styleFactor(style){
        if(style === "possession") return 1.08;
        if(style === "transition") return 1.10;
        if(style === "direct")     return 1.05;
        if(style === "low_block")  return 0.95;
        if(style === "high_press") return 1.07;
        return 1.00;
    }

    xT_H *= styleFactor(styleH);
    xT_A *= styleFactor(styleA);

    PSZ.state.xt = {xT_H, xT_A};

    const diff = xT_H - xT_A;
    let label;
    if(diff >= 0.6)      label = "Home punya ancaman progresif jauh lebih tinggi.";
    else if(diff >= 0.25)label = "Home sedikit unggul dalam ancaman progresif.";
    else if(diff <= -0.6)label = "Away punya ancaman progresif jauh lebih tinggi.";
    else if(diff <= -0.25)label = "Away sedikit unggul dalam ancaman progresif.";
    else                  label = "Ancaman progresif relatif seimbang.";

    PSZ.log(`xT Home ≈ ${xT_H.toFixed(2)}, xT Away ≈ ${xT_A.toFixed(2)}`);
    PSZ.log("Interpretasi: " + label);
};


// ==================================================
// BIND TOMBOL PART 7
// ==================================================
PSZ.el("btnDIM") && (PSZ.el("btnDIM").onclick = ()=> PSZ.runDIM());
PSZ.el("btnTCA") && (PSZ.el("btnTCA").onclick = ()=> PSZ.runTCA());
PSZ.el("btnPIM") && (PSZ.el("btnPIM").onclick = ()=> PSZ.runPIM());
PSZ.el("btnXT")  && (PSZ.el("btnXT").onclick  = ()=> PSZ.runXT());

PSZ.log("PART 7 Loaded: DIM + TCA + PIM v2 + xT-lite aktif.");

</script>
  </body>
  </html>
