<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Prime Singularity Zero â€“ Parlay Engine (Rebuild)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- =======================
       PART 1 â€“ FUTURISTIC UI
       ======================= -->
  <style>
  :root{
    --bg:#02030a;
    --bg-panel:#070a16;
    --accent:#12e4ff;
    --accent-soft:#12b8e3;
    --accent-2:#7bffb5;
    --border:#232843;
    --text:#f5f7ff;
    --muted:#8f95c7;
    --danger:#ff4f81;
  }
  *{
    box-sizing:border-box;
  }
  body{
    margin:0;
    padding:24px;
    background:
      radial-gradient(circle at top,#142042 0,#02030a 55%,#000 100%);
    color:var(--text);
    font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;
  }
  h1{
    font-size:24px;
    margin:0 0 14px;
    text-transform:uppercase;
    letter-spacing:0.15em;
    color:var(--accent);
    text-shadow:
      0 0 18px rgba(18,228,255,.85),
      0 0 40px rgba(0,0,0,.9);
  }
  h2{
    font-size:14px;
    margin:0 0 8px;
    letter-spacing:.06em;
    text-transform:uppercase;
    color:#e5e9ff;
  }
  h3{
    font-size:12px;
    margin:8px 0 6px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:.08em;
  }
  .layout{
    display:grid;
    grid-template-columns:minmax(0,1.5fr) minmax(0,1fr);
    gap:18px;
    align-items:flex-start;
  }
  .layout-main{
    display:flex;
    flex-direction:column;
    gap:14px;
  }
  .layout-side{
    position:sticky;
    top:18px;
  }
  .section{
    padding:12px 14px 14px;
    border-radius:12px;
    border:1px solid rgba(74,98,210,.7);
    background:
      linear-gradient(145deg,rgba(9,13,35,.96),rgba(5,9,24,.96));
    box-shadow:
      0 0 22px rgba(4,255,214,.12),
      0 0 60px rgba(0,0,0,.8);
    backdrop-filter:blur(18px);
  }
  label{
    display:block;
    margin-top:6px;
    font-size:11px;
    color:var(--muted);
  }
  input,
  select{
    width:100%;
    margin-top:3px;
    padding:7px 9px;
    border-radius:8px;
    border:1px solid rgba(86,102,160,.9);
    background:
      radial-gradient(circle at top,rgba(34,42,92,.9),rgba(8,11,32,.98));
    color:var(--text);
    font-size:11px;
    outline:none;
    transition:
      border .16s ease,
      box-shadow .16s ease,
      background .16s ease;
  }
  input:focus,
  select:focus{
    border-color:var(--accent);
    box-shadow:
      0 0 0 1px rgba(18,228,255,.3),
      0 0 18px rgba(0,255,204,.25);
  }
  input::placeholder{
    color:rgba(160,168,220,.65);
  }
  .inline-2{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:8px;
  }
  .inline-3{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:6px;
  }
  .inline-4{
    display:grid;
    grid-template-columns:repeat(4,minmax(0,1fr));
    gap:6px;
  }
  button{
    display:inline-block;
    margin-top:8px;
    margin-right:6px;
    margin-bottom:4px;
    padding:7px 11px;
    border-radius:999px;
    border:none;
    background:linear-gradient(135deg,var(--accent-soft),var(--accent));
    color:#000;
    font-size:10px;
    font-weight:700;
    letter-spacing:.08em;
    text-transform:uppercase;
    cursor:pointer;
    box-shadow:0 0 16px rgba(18,228,255,.6);
    transition:
      transform .12s ease,
      box-shadow .12s ease,
      filter .12s ease;
  }
  button:hover{
    transform:translateY(-1px) scale(1.01);
    box-shadow:0 0 22px rgba(18,228,255,.9);
    filter:brightness(1.05);
  }
  button:active{
    transform:translateY(0) scale(.99);
    box-shadow:0 0 10px rgba(18,228,255,.6);
  }
  textarea{
    width:100%;
    height:380px;
    margin-top:8px;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid rgba(60,80,150,.9);
    background:#02030a;
    color:#38ff9c;
    font-family:"JetBrains Mono","Fira Code",monospace;
    font-size:11px;
    line-height:1.32;
    white-space:pre;
    box-shadow:0 0 14px rgba(0,255,153,.3);
  }
  small{
    display:block;
    margin-top:3px;
    font-size:10px;
    color:var(--muted);
  }
  hr.line{
    margin:10px 0;
    border:0;
    border-top:1px dashed rgba(70,96,175,.9);
  }
  .badge-row{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin:4px 0 6px;
  }
  .badge{
    padding:3px 7px;
    border-radius:999px;
    border:1px solid rgba(120,140,255,.6);
    font-size:9px;
    letter-spacing:.09em;
    text-transform:uppercase;
    color:var(--muted);
    background:radial-gradient(circle at top,rgba(43,55,120,.9),rgba(8,11,26,1));
  }
  .badge--manual{
    border-color:#ff9f4f;
    color:#ffd6a0;
  }
  .badge--auto{
    border-color:#4dffb5;
    color:#b6ffdf;
  }
  @media (max-width:960px){
    body{padding:14px;}
    .layout{
      grid-template-columns:minmax(0,1fr);
    }
    .layout-side{
      position:static;
    }
  }
  </style>
</head>
<body>
  <div class="layout">
    <!-- ================= MAIN INPUT SIDE ================= -->
    <div class="layout-main">
      <h1>PRIME SINGULARITY ZERO â€“ PARLAY ENGINE</h1>

      <!-- 1. Info pertandingan -->
      <div class="section">
        <h2>1. Info Pertandingan</h2>
        <div class="inline-2">
          <div>
            <label>Home Team</label>
            <input id="home_team" type="text" placeholder="Contoh: Fulham">
          </div>
          <div>
            <label>Away Team</label>
            <input id="away_team" type="text" placeholder="Contoh: Manchester City">
          </div>
        </div>
        <div class="inline-3">
          <div>
            <label>Kompetisi / Liga</label>
            <input id="league_name" type="text" placeholder="EPL, UCL, dll.">
          </div>
          <div>
            <label>Tipe Pertandingan</label>
            <select id="match_type">
              <option value="league">Liga biasa</option>
              <option value="big_match">Big match</option>
              <option value="derby">Derby / Rivalitas</option>
              <option value="cup">Cup / Knockout</option>
              <option value="final">Final</option>
              <option value="relegation">Zona degradasi</option>
            </select>
          </div>
          <div>
            <label>Venue</label>
            <select id="venue_type">
              <option value="home_strong">Kandang kuat</option>
              <option value="home_normal">Kandang normal</option>
              <option value="neutral">Neutral</option>
              <option value="away_difficult">Tandang sulit</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 2. Statistik dasar per laga -->
      <div class="section">
        <h2>2. Statistik Dasar per Laga</h2>
        <div class="badge-row">
          <span class="badge badge--manual">Input Manual</span>
          <span class="badge badge--auto">Dipakai untuk AUTO-CALC</span>
        </div>
        <h3>Home</h3>
        <div class="inline-4">
          <div>
            <label>GF Home / match</label>
            <input id="h_gf" type="number" step="0.01" placeholder="1.60">
          </div>
          <div>
            <label>GA Home / match</label>
            <input id="h_ga" type="number" step="0.01" placeholder="1.10">
          </div>
          <div>
            <label>xG Home / match</label>
            <input id="adv_xg_home" type="number" step="0.01" placeholder="1.55">
          </div>
          <div>
            <label>xGA Home / match</label>
            <input id="adv_xga_home" type="number" step="0.01" placeholder="1.20">
          </div>
        </div>
        <h3>Away</h3>
        <div class="inline-4">
          <div>
            <label>GF Away / match</label>
            <input id="a_gf" type="number" step="0.01" placeholder="1.80">
          </div>
          <div>
            <label>GA Away / match</label>
            <input id="a_ga" type="number" step="0.01" placeholder="1.30">
          </div>
          <div>
            <label>xG Away / match</label>
            <input id="adv_xg_away" type="number" step="0.01" placeholder="1.75">
          </div>
          <div>
            <label>xGA Away / match</label>
            <input id="adv_xga_away" type="number" step="0.01" placeholder="1.35">
          </div>
        </div>
      </div>

      <!-- 3. Form & Momentum -->
      <div class="section">
        <h2>3. Form & Momentum</h2>
        <h3>Form 5 Laga Terakhir (W-D-L)</h3>
        <div class="inline-2">
          <div>
            <label>Home â€“ W / D / L</label>
            <div class="inline-3">
              <input id="form_home_w" type="number" placeholder="3">
              <input id="form_home_d" type="number" placeholder="1">
              <input id="form_home_l" type="number" placeholder="1">
            </div>
          </div>
          <div>
            <label>Away â€“ W / D / L</label>
            <div class="inline-3">
              <input id="form_away_w" type="number" placeholder="2">
              <input id="form_away_d" type="number" placeholder="2">
              <input id="form_away_l" type="number" placeholder="1">
            </div>
          </div>
        </div>
        <div class="inline-3">
          <div>
            <label>Momentum Home (0â€“10)</label>
            <input id="home_mom" type="number" step="0.1" placeholder="5.0">
          </div>
          <div>
            <label>Momentum Away (0â€“10)</label>
            <input id="away_mom" type="number" step="0.1" placeholder="5.0">
          </div>
          <div>
            <label>Stabilitas Home (0â€“10)</label>
            <input id="home_stab" type="number" step="0.1" placeholder="5.0">
          </div>
        </div>
        <div class="inline-2">
          <div>
            <label>Stabilitas Away (0â€“10)</label>
            <input id="away_stab" type="number" step="0.1" placeholder="5.0">
          </div>
          <div>
            <label>Match Importance (0â€“10)</label>
            <input id="importance_input" type="number" step="0.1" placeholder="5.0">
          </div>
        </div>
      </div>

      <!-- 4. Pressing & PPDA -->
      <div class="section">
        <h2>4. Pressing & PPDA</h2>
        <div class="badge-row">
          <span class="badge badge--manual">Isi jika ada data PPDA asli</span>
          <span class="badge badge--auto">Kalau tidak ada, pakai gaya pressing â†’ AUTO PPDA</span>
        </div>
        <h3>Gaya Pressing</h3>
        <div class="inline-2">
          <div>
            <label>Pressing Home</label>
            <select id="press_style_home">
              <option value="">Pilih gaya pressing</option>
              <option value="extreme_high">Extreme High Press</option>
              <option value="gegenpress">Gegenpress</option>
              <option value="semi_gegenpress">Semi-Gegenpress</option>
              <option value="positional_high">Positional High</option>
              <option value="reactive_press">Reactive Mid Press</option>
              <option value="zonal_midlow">Zonal Mid-Low</option>
              <option value="deep_low">Deep Low Block</option>
              <option value="wing_press">Wing Trap Press</option>
              <option value="inverted_press">Inverted Lane Press</option>
              <option value="ultra_compact">Ultra Compact Block</option>
            </select>
          </div>
          <div>
            <label>Pressing Away</label>
            <select id="press_style_away">
              <option value="">Pilih gaya pressing</option>
              <option value="extreme_high">Extreme High Press</option>
              <option value="gegenpress">Gegenpress</option>
              <option value="semi_gegenpress">Semi-Gegenpress</option>
              <option value="positional_high">Positional High</option>
              <option value="reactive_press">Reactive Mid Press</option>
              <option value="zonal_midlow">Zonal Mid-Low</option>
              <option value="deep_low">Deep Low Block</option>
              <option value="wing_press">Wing Trap Press</option>
              <option value="inverted_press">Inverted Lane Press</option>
              <option value="ultra_compact">Ultra Compact Block</option>
            </select>
          </div>
        </div>
        <h3>PPDA & Error Defensive</h3>
        <div class="inline-4">
          <div>
            <label>PPDA Home (jika ada)</label>
            <input id="adv_ppda_home" type="number" step="0.01" placeholder="isi manual / auto">
          </div>
          <div>
            <label>PPDA Away (jika ada)</label>
            <input id="adv_ppda_away" type="number" step="0.01" placeholder="isi manual / auto">
          </div>
          <div>
            <label>Error Defensif Home / match</label>
            <input id="adv_err_home" type="number" step="0.01" placeholder="0.15">
          </div>
          <div>
            <label>Error Defensif Away / match</label>
            <input id="adv_err_away" type="number" step="0.01" placeholder="0.18">
          </div>
        </div>
        <div class="inline-2">
          <div>
            <label>Index Press Home (0â€“10)</label>
            <input id="home_press" type="number" step="0.1" placeholder="5.0">
          </div>
          <div>
            <label>Index Press Away (0â€“10)</label>
            <input id="away_press" type="number" step="0.1" placeholder="5.0">
          </div>
        </div>
        <button id="btn_auto_ppda">AUTO ESTIMATE PPDA (Lite)</button>
        <button id="btn_auto_ppda_ext">AUTO PPDA EXTENDED</button>
        <small>Jika PPDA tidak tersedia, pilih gaya pressing lalu gunakan tombol AUTO untuk estimasi.</small>
      </div>

      <!-- 5. Tempo / Chaos / Importance & Match Style -->
      <div class="section">
        <h2>5. Tempo / Chaos / Match Style</h2>
        <div class="inline-3">
          <div>
            <label>Tempo (0â€“10)</label>
            <input id="tempo_input" type="number" step="0.1" placeholder="5.0">
          </div>
          <div>
            <label>Chaos (0â€“10)</label>
            <input id="chaos_input" type="number" step="0.1" placeholder="5.0">
          </div>
          <div>
            <label>Intensity (opsional)</label>
            <input id="intensity_input" type="number" step="0.1" placeholder="5.0">
          </div>
        </div>
        <div class="inline-2">
          <div>
            <label>Perkiraan Gaya Laga</label>
            <select id="match_style">
              <option value="">Pilih style</option>
              <option value="slow_control">Slow â€“ Control / Positional</option>
              <option value="balanced">Balanced Game</option>
              <option value="fast_direct">Fast Direct</option>
              <option value="transition_wild">Transition / Wild</option>
            </select>
          </div>
          <div>
            <label>Lingkungan Gol (perkiraan)</label>
            <select id="goal_env">
              <option value="">Pilih</option>
              <option value="low">Low Scoring</option>
              <option value="medium">Medium</option>
              <option value="high">High Scoring</option>
            </select>
          </div>
        </div>
        <button id="btn_auto_tci">AUTO TEMPO / CHAOS / IMPORTANCE</button>
        <small>Engine akan baca pressing, PPDA, form & match type untuk mengisi TCI secara otomatis.</small>
      </div>

      <!-- 6. Taktik & Fleksibilitas -->
      <div class="section">
        <h2>6. Taktik & Fleksibilitas</h2>
        <h3>Formasi Potensial</h3>
        <div class="inline-2">
          <div>
            <label>Formasi Home (1â€“3 opsi)</label>
            <input id="home_form1" type="text" placeholder="4-3-3">
            <input id="home_form2" type="text" placeholder="4-2-3-1 (opsional)">
            <input id="home_form3" type="text" placeholder="3-4-3 (opsional)">
          </div>
          <div>
            <label>Formasi Away (1â€“3 opsi)</label>
            <input id="away_form1" type="text" placeholder="4-4-2">
            <input id="away_form2" type="text" placeholder="4-3-3 (opsional)">
            <input id="away_form3" type="text" placeholder="5-3-2 (opsional)">
          </div>
        </div>
        <div class="inline-3">
          <div>
            <label>Fleksibilitas Taktik Home (0â€“10)</label>
            <input id="home_flex" type="number" step="0.1" placeholder="5.0">
          </div>
          <div>
            <label>Fleksibilitas Taktik Away (0â€“10)</label>
            <input id="away_flex" type="number" step="0.1" placeholder="5.0">
          </div>
          <div>
            <label>Match Plan (opsional)</label>
            <select id="match_plan">
              <option value="">Default</option>
              <option value="home_attack">Home ingin dominan menyerang</option>
              <option value="away_counter">Away fokus counter</option>
              <option value="tight_tactical">Dua tim taktikal & hati-hati</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 7. BRM & Info Bankroll (opsional) -->
      <div class="section">
        <h2>7. Bankroll & Profil Risiko (Opsional)</h2>
        <div class="inline-3">
          <div>
            <label>Bankroll total</label>
            <input id="bankroll" type="number" step="1" placeholder="contoh: 1000000">
          </div>
          <div>
            <label>Profil Risiko</label>
            <select id="risk_profile">
              <option value="normal">Normal</option>
              <option value="conservative">Conservative</option>
              <option value="aggressive">Aggressive</option>
            </select>
          </div>
          <div>
            <label>Target Hit Rate (%) (opsional)</label>
            <input id="target_hit" type="number" step="0.1" placeholder="55">
          </div>
        </div>
        <small>Jika dikosongkan, BRM akan memakai asumsi normal & hanya memberi rekomendasi persentase.</small>
      </div>

      <!-- 8. Tombol Engine & Tools (semua didefinisikan di PART 2+) -->
      <div class="section">
        <h2>8. ENGINE & TOOLS</h2>
        <h3>Auto & Pre-Processing</h3>
        <button id="btn_auto_calc">AUTO-CALC INPUT WAJIB</button>
        <button id="btn_auto_tci2">AUTO TCI (ALT)</button>
        <button id="btn_sanitize">SANITIZE INPUT</button>

        <hr class="line">
        <h3>Engine Utama</h3>
        <button id="btn_analyze">PRIME SINGULARITY ZERO</button>
        <button id="btn_infinity">INFINITY ENGINE</button>
        <button id="btn_grand_unified">GRAND UNIFIED ENGINE</button>

        <hr class="line">
        <h3>Analisis Lanjutan</h3>
        <button id="btn_match_difficulty">MATCH DIFFICULTY</button>
        <button id="btn_match_flow">MATCH FLOW</button>
        <button id="btn_team_trend">TEAM TREND</button>
        <button id="btn_set_piece">SET PIECE POWER</button>

        <hr class="line">
        <h3>BRM & PARLAY TOOLS</h3>
        <button id="btn_brm_bankroll">BRM BANKROLL</button>
        <button id="btn_brm_parlay">PARLAY HELPER</button>
        <button id="btn_brm_edge">EDGE CLASSIFIER</button>
        <button id="btn_brm_suite">RUN BRM SUITE</button>

        <small>Seluruh fungsi tombol akan diisi di PART 2â€“7 (JavaScript) dengan engine yang rapi & tanpa error.</small>
      </div>
    </div>

    <!-- ================= OUTPUT SIDE ================= -->
    <div class="layout-side">
      <div class="section">
        <h2>OUTPUT ANALISIS</h2>
        <small>Semua hasil engine (Prime, Infinity, PPDA, BRM, dll.) akan muncul di sini.</small>
        <textarea id="output" placeholder="Log analisis akan tampil di sini..."></textarea>
        <button id="btn_clear_output">CLEAR OUTPUT</button>
      </div>
    </div>
  </div>

  <!-- PART 1: Belum ada JS engine. PART 2â€“7 akan menambahkan semua logika. -->
  <script>
  <script>
// ============================================
// PART 2 â€“ CORE ENGINE FOUNDATION (PSZ CORE)
// ============================================

// Namespace utama
const PSZ = {
  state: {
    lamH: 1.2,
    lamA: 1.0
  },

  // Ambil elemen
  el(id){
    return document.getElementById(id);
  },

  // Ambil nilai number aman
  num(id, fallback = 0){
    const el = PSZ.el(id);
    if(!el) return fallback;
    const v = parseFloat(el.value);
    if(isNaN(v) || !isFinite(v)) return fallback;
    return v;
  },

  // Ambil teks
  text(id, fallback = ""){
    const el = PSZ.el(id);
    if(!el) return fallback;
    return (el.value || "").toString().trim();
  },

  // Tulis log ke output
  log(line){
    const out = PSZ.el("output");
    if(!out) return;
    const t = `[${new Date().toLocaleTimeString()}] ${line}\n`;
    out.value += t;
    out.scrollTop = out.scrollHeight;
  },

  // Clear output
  clearOutput(){
    const out = PSZ.el("output");
    if(out) out.value = "";
  }
};

// --------------------------------------------
// SANITIZE INPUT â€“ mengamankan semua input number
// --------------------------------------------
PSZ.sanitizeInputs = function(){
  const inputs = document.querySelectorAll("input[type='number']");
  inputs.forEach(inp => {
    if(inp.value === "" || inp.value === null){
      inp.value = "";
      return;
    }
    let v = parseFloat(inp.value);
    if(isNaN(v) || !isFinite(v)){
      inp.value = "";
      return;
    }
    // Batasi nilai ekstrem
    if(v > 999999999) v = 999999999;
    if(v < -999999999) v = -999999999;
    inp.value = v;
  });
  PSZ.log("SANITIZE: Semua input numerik dicek & dibersihkan.");
};

// --------------------------------------------
// AUTO-CALC INPUT WAJIB (Î»H & Î»A dasar)
// Ini versi dasar â€“ nanti bisa ditajamkan di Part berikutnya.
// --------------------------------------------
PSZ.autoCalcRequired = function(){
  PSZ.sanitizeInputs();

  // Stat dasar Home
  const h_gf   = PSZ.num("h_gf", 1.2);
  const h_ga   = PSZ.num("h_ga", 1.1);
  const hxg    = PSZ.num("adv_xg_home", h_gf);
  const hxga   = PSZ.num("adv_xga_home", h_ga);

  // Stat dasar Away
  const a_gf   = PSZ.num("a_gf", 1.3);
  const a_ga   = PSZ.num("a_ga", 1.2);
  const axg    = PSZ.num("adv_xg_away", a_gf);
  const axga   = PSZ.num("adv_xga_away", a_ga);

  // Form
  const fh_w   = PSZ.num("form_home_w", 0);
  const fh_d   = PSZ.num("form_home_d", 0);
  const fh_l   = PSZ.num("form_home_l", 0);
  const fa_w   = PSZ.num("form_away_w", 0);
  const fa_d   = PSZ.num("form_away_d", 0);
  const fa_l   = PSZ.num("form_away_l", 0);

  const homeMom = PSZ.num("home_mom", 5);
  const awayMom = PSZ.num("away_mom", 5);

  // League baseline (bisa diubah nanti)
  const LEAGUE_avg_GF = 1.40;
  const LEAGUE_avg_GA = 1.40;

  // Attack index (Home menyerang, Away bertahan)
  const homeAttack = (h_gf + hxg) / 2;
  const awayDefenseGA = (a_ga + axga) / 2;

  // Attack index (Away menyerang, Home bertahan)
  const awayAttack = (a_gf + axg) / 2;
  const homeDefenseGA = (h_ga + hxga) / 2;

  // Form effect sederhana
  const formScoreHome = fh_w*2.3 + fh_d*0.9 - fh_l*1.8 + (homeMom - 5)*0.8;
  const formScoreAway = fa_w*2.3 + fa_d*0.9 - fa_l*1.8 + (awayMom - 5)*0.8;

  const formAdjHome = 1 + (formScoreHome / 40); // kisaran Â±0.3 tipikal
  const formAdjAway = 1 + (formScoreAway / 40);

  // Defense index: semakin besar GA/xGA, semakin lemah
  const homeDefIdx = LEAGUE_avg_GA / Math.max(0.4, homeDefenseGA);
  const awayDefIdx = LEAGUE_avg_GA / Math.max(0.4, awayDefenseGA);

  // Core Î»
  let lamH = 1.35 * (homeAttack / LEAGUE_avg_GF) * awayDefIdx * formAdjHome;
  let lamA = 1.25 * (awayAttack / LEAGUE_avg_GF) * homeDefIdx * formAdjAway;

  // Clamp
  lamH = Math.max(0.2, Math.min(4.5, lamH));
  lamA = Math.max(0.2, Math.min(4.5, lamA));

  PSZ.state.lamH = lamH;
  PSZ.state.lamA = lamA;

  PSZ.log(`AUTO-CALC: Î»H â‰ˆ ${lamH.toFixed(3)}, Î»A â‰ˆ ${lamA.toFixed(3)} (base model).`);
};

// --------------------------------------------
// AUTO TCI (versi dasar â€“ masih simple)
// --------------------------------------------
PSZ.autoFillTCI = function(){
  const pressH = PSZ.num("home_press", 5);
  const pressA = PSZ.num("away_press", 5);
  const ppdaH  = PSZ.num("adv_ppda_home", 0);
  const ppdaA  = PSZ.num("adv_ppda_away", 0);

  const matchType = PSZ.text("match_type", "league");
  const style     = PSZ.text("match_style", "");
  const goalEnv   = PSZ.text("goal_env", "");

  // Tempo dasar dari pressing
  let tempo = (pressH + pressA) / 2;
  // Chaos dasar dari perbedaan pressing & error defensif
  const errH  = PSZ.num("adv_err_home", 0.15);
  const errA  = PSZ.num("adv_err_away", 0.18);
  let chaos   = Math.abs(pressH - pressA) * 0.5 + (errH + errA) * 8;

  // Pengaruh match type
  if(matchType === "final" || matchType === "relegation"){
    tempo -= 0.4;
    chaos += 0.6;
  } else if(matchType === "big_match" || matchType === "derby"){
    tempo += 0.4;
    chaos += 0.4;
  }

  // Pengaruh style manual jika ada
  if(style === "slow_control"){
    tempo -= 1.0;
    chaos -= 0.5;
  } else if(style === "fast_direct" || style === "transition_wild"){
    tempo += 0.8;
    chaos += 0.8;
  }

  // Goal env
  if(goalEnv === "low"){
    tempo -= 0.5;
  } else if(goalEnv === "high"){
    tempo += 0.5;
    chaos += 0.3;
  }

  // Clamp 0â€“10
  tempo = Math.max(0, Math.min(10, tempo));
  chaos = Math.max(0, Math.min(10, chaos));

  // Importance: berdasarkan match type + form
  let imp = PSZ.num("importance_input", 5);
  if(matchType === "final" || matchType === "relegation") imp = 9;
  else if(matchType === "big_match" || matchType === "derby") imp = 8;
  else if(matchType === "cup") imp = 7;

  PSZ.el("tempo_input").value = tempo.toFixed(1);
  PSZ.el("chaos_input").value = chaos.toFixed(1);
  PSZ.el("importance_input").value = imp.toFixed(1);

  PSZ.log(`AUTO-TCI: Tempo=${tempo.toFixed(1)}, Chaos=${chaos.toFixed(1)}, Importance=${imp.toFixed(1)}.`);
};

// --------------------------------------------
// AUTO PPDA LITE (pakai PPDA jika kosong)
// --------------------------------------------
PSZ.autoEstimatePPDA_Lite = function(){
  // Jika sudah ada PPDA, tidak perlu diisi ulang
  let ppdaH = PSZ.num("adv_ppda_home", 0);
  let ppdaA = PSZ.num("adv_ppda_away", 0);

  const styleH = PSZ.text("press_style_home","");
  const styleA = PSZ.text("press_style_away","");

  function guess(style){
    switch(style){
      case "extreme_high":   return 5.5;
      case "gegenpress":     return 7.0;
      case "semi_gegenpress":return 8.5;
      case "positional_high":return 9.5;
      case "reactive_press": return 12.0;
      case "zonal_midlow":   return 15.0;
      case "deep_low":       return 18.0;
      case "wing_press":     return 13.5;
      case "inverted_press": return 10.5;
      case "ultra_compact":  return 19.5;
      default:               return null;
    }
  }

  if(!ppdaH){
    const g = guess(styleH);
    if(g !== null){
      ppdaH = g;
      PSZ.el("adv_ppda_home").value = ppdaH.toFixed(2);
    }
  }
  if(!ppdaA){
    const g = guess(styleA);
    if(g !== null){
      ppdaA = g;
      PSZ.el("adv_ppda_away").value = ppdaA.toFixed(2);
    }
  }

  // Press index kasar dari PPDA
  if(ppdaH){
    const pressIdxH = Math.max(0, Math.min(10, 12 - ppdaH/2));
    PSZ.el("home_press").value = pressIdxH.toFixed(2);
  }
  if(ppdaA){
    const pressIdxA = Math.max(0, Math.min(10, 12 - ppdaA/2));
    PSZ.el("away_press").value = pressIdxA.toFixed(2);
  }

  PSZ.log(`AUTO-PPDA LITE: Home=${ppdaH ? ppdaH.toFixed(2) : "manual"}, Away=${ppdaA ? ppdaA.toFixed(2) : "manual"}.`);
};

// --------------------------------------------
// AUTO PPDA EXTENDED â€“ untuk sementara pakai Lite + sedikit penyesuaian
// (NANTI bisa kita ganti dengan versi lebih detail di Part berikutnya)
// --------------------------------------------
PSZ.autoPPDA_Extended = function(){
  PSZ.autoEstimatePPDA_Lite();

  let ppdaH = PSZ.num("adv_ppda_home", 0);
  let ppdaA = PSZ.num("adv_ppda_away", 0);
  const xgaH = PSZ.num("adv_xga_home", 1.2);
  const xgaA = PSZ.num("adv_xga_away", 1.2);
  const errH = PSZ.num("adv_err_home", 0.15);
  const errA = PSZ.num("adv_err_away", 0.18);

  if(ppdaH){
    ppdaH -= xgaA * 0.15;
    ppdaH += errH * 0.4;
    ppdaH = Math.max(3.5, Math.min(22, ppdaH));
    PSZ.el("adv_ppda_home").value = ppdaH.toFixed(2);
  }
  if(ppdaA){
    ppdaA -= xgaH * 0.15;
    ppdaA += errA * 0.4;
    ppdaA = Math.max(3.5, Math.min(22, ppdaA));
    PSZ.el("adv_ppda_away").value = ppdaA.toFixed(2);
  }

  if(ppdaH){
    const pressIdxH = Math.max(0, Math.min(10, 12 - ppdaH/2));
    PSZ.el("home_press").value = pressIdxH.toFixed(2);
  }
  if(ppdaA){
    const pressIdxA = Math.max(0, Math.min(10, 12 - ppdaA/2));
    PSZ.el("away_press").value = pressIdxA.toFixed(2);
  }

  PSZ.log(`AUTO-PPDA EXTENDED: Home=${ppdaH ? ppdaH.toFixed(2) : "n/a"}, Away=${ppdaA ? ppdaA.toFixed(2) : "n/a"}.`);
};

// --------------------------------------------
// PRIME SINGULARITY ZERO â€“ versi ringkas dulu
// (detail Poisson, dll, akan diisi Part 3)
// --------------------------------------------
PSZ.runPrimeZero = function(){
  // Pastikan Î» sudah dihitung
  PSZ.autoCalcRequired();

  const lamH = PSZ.state.lamH;
  const lamA = PSZ.state.lamA;

  const tempo = PSZ.num("tempo_input", 5);
  const chaos = PSZ.num("chaos_input", 5);

  PSZ.log("========================================");
  PSZ.log("PRIME SINGULARITY ZERO (versi dasar)");
  PSZ.log(`Î»H=${lamH.toFixed(3)}, Î»A=${lamA.toFixed(3)}, Tempo=${tempo.toFixed(1)}, Chaos=${chaos.toFixed(1)}.`);
  PSZ.log("Detail distribusi skor & probabilitas akan diisi pada PART 3.");
};

// --------------------------------------------
// RUN INFINITY & GRAND UNIFIED â€“ sementara placeholder aman
// --------------------------------------------
PSZ.runInfinity = function(){
  PSZ.log("INFINITY ENGINE: Placeholder â€“ logika detail akan diisi di PART 4.");
};

PSZ.runGrandUnified = function(){
  PSZ.log("GRAND UNIFIED ENGINE: Placeholder â€“ integrasi penuh akan diisi di PART 5.");
};

// --------------------------------------------
// MATCH DIFFICULTY / FLOW / TREND / SET PIECE â€“ placeholder
// --------------------------------------------
PSZ.runMatchDifficulty = function(){
  PSZ.log("MATCH DIFFICULTY: akan diaktifkan di part lanjutan (tanpa error).");
};
PSZ.runMatchFlow = function(){
  PSZ.log("MATCH FLOW: akan diaktifkan di part lanjutan (tanpa error).");
};
PSZ.runTeamTrend = function(){
  PSZ.log("TEAM TREND: akan diaktifkan di part lanjutan (tanpa error).");
};
PSZ.runSetPiece = function(){
  PSZ.log("SET PIECE POWER: akan diaktifkan di part lanjutan (tanpa error).");
};

// --------------------------------------------
// BRM â€“ placeholder aman (detail di part BRM)
// --------------------------------------------
PSZ.runBRM_Bankroll = function(){
  PSZ.log("BRM BANKROLL: modul detail akan diisi di PART BRM (lanjutan).");
};
PSZ.runBRM_Parlay = function(){
  PSZ.log("BRM PARLAY HELPER: modul detail akan diisi di PART BRM (lanjutan).");
};
PSZ.runBRM_Edge = function(){
  PSZ.log("BRM EDGE CLASSIFIER: modul detail akan diisi di PART BRM (lanjutan).");
};
PSZ.runBRM_Suite = function(){
  PSZ.runBRM_Bankroll();
  PSZ.runBRM_Parlay();
  PSZ.runBRM_Edge();
  PSZ.log("BRM SUITE: selesai (versi placeholder, aman tanpa error).");
};

// --------------------------------------------
// WIRING TOMBOL â€“ DOMContentLoaded
// --------------------------------------------
document.addEventListener("DOMContentLoaded", function(){
  // Clear output
  const btnClear = PSZ.el("btn_clear_output");
  if(btnClear){
    btnClear.addEventListener("click", PSZ.clearOutput);
  }

  // Auto-calc
  const btnAutoCalc = PSZ.el("btn_auto_calc");
  if(btnAutoCalc){
    btnAutoCalc.addEventListener("click", function(){
      try{
        PSZ.autoCalcRequired();
      }catch(e){
        console.error(e);
        alert("Error AUTO-CALC INPUT WAJIB (cek console).");
      }
    });
  }

  // Auto TCI (utama)
  const btnAutoTCI1 = PSZ.el("btn_auto_tci");
  if(btnAutoTCI1){
    btnAutoTCI1.addEventListener("click", function(){
      try{
        PSZ.autoFillTCI();
      }catch(e){
        console.error(e);
        alert("Error AUTO TCI (cek console).");
      }
    });
  }
  // Auto TCI ALT (btn_auto_tci2)
  const btnAutoTCI2 = PSZ.el("btn_auto_tci2");
  if(btnAutoTCI2){
    btnAutoTCI2.addEventListener("click", function(){
      try{
        PSZ.autoFillTCI();
      }catch(e){
        console.error(e);
        alert("Error AUTO TCI ALT (cek console).");
      }
    });
  }

  // Sanitize
  const btnSan = PSZ.el("btn_sanitize");
  if(btnSan){
    btnSan.addEventListener("click", function(){
      try{
        PSZ.sanitizeInputs();
      }catch(e){
        console.error(e);
        alert("Error SANITIZE INPUT (cek console).");
      }
    });
  }

  // Auto PPDA
  const btnPPDA_Lite = PSZ.el("btn_auto_ppda");
  if(btnPPDA_Lite){
    btnPPDA_Lite.addEventListener("click", function(){
      try{
        PSZ.autoEstimatePPDA_Lite();
      }catch(e){
        console.error(e);
        alert("Error AUTO PPDA LITE (cek console).");
      }
    });
  }

  const btnPPDA_Ext = PSZ.el("btn_auto_ppda_ext");
  if(btnPPDA_Ext){
    btnPPDA_Ext.addEventListener("click", function(){
      try{
        PSZ.autoPPDA_Extended();
      }catch(e){
        console.error(e);
        alert("Error AUTO PPDA EXTENDED (cek console).");
      }
    });
  }

  // Engine utama
  const btnAnalyze = PSZ.el("btn_analyze");
  if(btnAnalyze){
    btnAnalyze.addEventListener("click", function(){
      try{
        PSZ.runPrimeZero();
      }catch(e){
        console.error(e);
        alert("Error PRIME SINGULARITY ZERO (cek console).");
      }
    });
  }

  const btnInf = PSZ.el("btn_infinity");
  if(btnInf){
    btnInf.addEventListener("click", function(){
      try{
        PSZ.runInfinity();
      }catch(e){
        console.error(e);
        alert("Error INFINITY ENGINE (cek console).");
      }
    });
  }

  const btnGUN = PSZ.el("btn_grand_unified");
  if(btnGUN){
    btnGUN.addEventListener("click", function(){
      try{
        PSZ.runGrandUnified();
      }catch(e){
        console.error(e);
        alert("Error GRAND UNIFIED ENGINE (cek console).");
      }
    });
  }

  // Analisis lanjutan
  const btnMD = PSZ.el("btn_match_difficulty");
  if(btnMD){
    btnMD.addEventListener("click", function(){
      try{
        PSZ.runMatchDifficulty();
      }catch(e){
        console.error(e);
        alert("Error MATCH DIFFICULTY (cek console).");
      }
    });
  }

  const btnMF = PSZ.el("btn_match_flow");
  if(btnMF){
    btnMF.addEventListener("click", function(){
      try{
        PSZ.runMatchFlow();
      }catch(e){
        console.error(e);
        alert("Error MATCH FLOW (cek console).");
      }
    });
  }

  const btnTT = PSZ.el("btn_team_trend");
  if(btnTT){
    btnTT.addEventListener("click", function(){
      try{
        PSZ.runTeamTrend();
      }catch(e){
        console.error(e);
        alert("Error TEAM TREND (cek console).");
      }
    });
  }

  const btnSP = PSZ.el("btn_set_piece");
  if(btnSP){
    btnSP.addEventListener("click", function(){
      try{
        PSZ.runSetPiece();
      }catch(e){
        console.error(e);
        alert("Error SET PIECE POWER (cek console).");
      }
    });
  }

  // BRM Buttons
  const btnBRM1 = PSZ.el("btn_brm_bankroll");
  if(btnBRM1){
    btnBRM1.addEventListener("click", function(){
      try{
        PSZ.runBRM_Bankroll();
      }catch(e){
        console.error(e);
        alert("Error BRM BANKROLL (cek console).");
      }
    });
  }
  const btnBRM2 = PSZ.el("btn_brm_parlay");
  if(btnBRM2){
    btnBRM2.addEventListener("click", function(){
      try{
        PSZ.runBRM_Parlay();
      }catch(e){
        console.error(e);
        alert("Error PARLAY HELPER (cek console).");
      }
    });
  }
  const btnBRM3 = PSZ.el("btn_brm_edge");
  if(btnBRM3){
    btnBRM3.addEventListener("click", function(){
      try{
        PSZ.runBRM_Edge();
      }catch(e){
        console.error(e);
        alert("Error EDGE CLASSIFIER (cek console).");
      }
    });
  }
  const btnBRM4 = PSZ.el("btn_brm_suite");
  if(btnBRM4){
    btnBRM4.addEventListener("click", function(){
      try{
        PSZ.runBRM_Suite();
      }catch(e){
        console.error(e);
        alert("Error BRM SUITE (cek console).");
      }
    });
  }

  PSZ.log("PSZ CORE v2: Engine dasar & wiring tombol siap. (PART 2 selesai)");
});
// ========================================================
// PART 3 â€“ PRIME ENGINE (Poisson Score Model + Probability)
// ========================================================

// Poisson factorial memo
const PSZ_factorialMemo = {};
function PSZ_fact(n){
  if(n <= 1) return 1;
  if(PSZ_factorialMemo[n]) return PSZ_factorialMemo[n];
  let r = 1;
  for(let i=2;i<=n;i++) r *= i;
  PSZ_factorialMemo[n] = r;
  return r;
}

// Poisson Probability
function PSZ_poisson(k, lambda){
  return Math.pow(lambda, k) * Math.exp(-lambda) / PSZ_fact(k);
}

// Main PRIME engine
PSZ.PRIME = function(){

  // Ambil Î» dari state
  const lamH = PSZ.state.lamH || 1.2;
  const lamA = PSZ.state.lamA || 1.0;

  const tempo = PSZ.num("tempo_input", 5);
  const chaos = PSZ.num("chaos_input", 5);

  // Penyesuaian TCI terhadap distribusi skor (opsional & aman)
  const tempoFactor = 1 + (tempo - 5) * 0.05;  // Â±25%
  const chaosFactor = 1 + (chaos - 5) * 0.04;  // Â±20%

  const adjH = lamH * tempoFactor;
  const adjA = lamA * tempoFactor;

  // ======================================================
  // 1. DISTRIBUSI SKOR 0â€“6 UNTUK KEDUA TIM
  // ======================================================
  const maxG = 6;
  let distH = [];
  let distA = [];

  for(let i=0;i<=maxG;i++){
    distH[i] = PSZ_poisson(i, adjH);
    distA[i] = PSZ_poisson(i, adjA);
  }

  // ======================================================
  // 2. HITUNG PROBABILITAS MATCH RESULT
  // ======================================================
  let pH = 0;   // Home Win
  let pD = 0;   // Draw
  let pA = 0;   // Away Win

  for(let h=0;h<=maxG;h++){
    for(let a=0;a<=maxG;a++){
      const p = distH[h] * distA[a];

      if(h > a) pH += p;
      else if(h === a) pD += p;
      else pA += p;
    }
  }

  // ======================================================
  // 3. CORRECT SCORE TABLE (0â€“6)
  // ======================================================
  let csLines = "";
  for(let h=0;h<=maxG;h++){
    for(let a=0;a<=maxG;a++){
      const p = distH[h] * distA[a];
      if(p >= 0.001){ // tampilkan yg >0.1%
        csLines += `${h}-${a}: ${(p*100).toFixed(2)}%\n`;
      }
    }
  }

  // ======================================================
  // 4. OVER/UNDER (dasar)
  // ======================================================
  function probOver(total){
    let p = 0;
    for(let h=0;h<=maxG;h++){
      for(let a=0;a<=maxG;a++){
        if(h+a > total){
          p += distH[h] * distA[a];
        }
      }
    }
    return p;
  }
  function probUnder(total){
    let p = 0;
    for(let h=0;h<=maxG;h++){
      for(let a=0;a<=maxG;a++){
        if(h+a < total){
          p += distH[h] * distA[a];
        }
      }
    }
    return p;
  }

  const O25 = probOver(2);
  const U25 = probUnder(2);
  const O35 = probOver(3);
  const U35 = probUnder(3);

  // ======================================================
  // 5. OUTPUT KE LOG
  // ======================================================
  PSZ.log("============================================");
  PSZ.log("ðŸ”¥ PRIME ENGINE â€“ SCORE & PROBABILITY MODEL");
  PSZ.log(`Î»H=${lamH.toFixed(3)}, Î»A=${lamA.toFixed(3)}`);
  PSZ.log(`Adj Î»H=${adjH.toFixed(3)}, Adj Î»A=${adjA.toFixed(3)} (TCI Adjust)`);

  // Match result
  PSZ.log(`Home Win: ${(pH*100).toFixed(2)}%`);
  PSZ.log(`Draw: ${(pD*100).toFixed(2)}%`);
  PSZ.log(`Away Win: ${(pA*100).toFixed(2)}%`);

  PSZ.log("--------------------------------------------");
  PSZ.log("Correct Score Probabilities (0â€“6):");
  PSZ.log(csLines);

  PSZ.log("--------------------------------------------");
  PSZ.log(`O2.5: ${(O25*100).toFixed(2)}%`);
  PSZ.log(`U2.5: ${(U25*100).toFixed(2)}%`);
  PSZ.log(`O3.5: ${(O35*100).toFixed(2)}%`);
  PSZ.log(`U3.5: ${(U35*100).toFixed(2)}%`);

  PSZ.log("Prime Engine selesai (PART 3).");
};

// Override tombol utama PRIME dengan engine ini
PSZ.runPrimeZero = function(){
  try{
    PSZ.autoCalcRequired();   // pastikan Î» siap
    PSZ.PRIME();              // jalankan engine
  }catch(e){
    console.error(e);
    alert("Error PRIME ENGINE (lihat console).");
  }
};
// ===========================================================
// PART 4 â€“ ADVANCED MATCH ENGINE
// Match Difficulty, Flow, Tactical Impact, Trend, Set Piece
// ===========================================================


// ================================
// 1) MATCH DIFFICULTY ENGINE
// ================================
PSZ.runMatchDifficulty = function(){

  const lamH = PSZ.state.lamH || 1.2;
  const lamA = PSZ.state.lamA || 1.0;

  const formH = (PSZ.num("form_home_w")*2.3 + PSZ.num("form_home_d")*0.9 - PSZ.num("form_home_l")*1.8);
  const formA = (PSZ.num("form_away_w")*2.3 + PSZ.num("form_away_d")*0.9 - PSZ.num("form_away_l")*1.8);

  const stabH = PSZ.num("home_stab",5);
  const stabA = PSZ.num("away_stab",5);

  const flexH = PSZ.num("home_flex",5);
  const flexA = PSZ.num("away_flex",5);

  // DEFENSE ERROR
  const errH = PSZ.num("adv_err_home", 0.15);
  const errA = PSZ.num("adv_err_away", 0.18);

  // Difficulty = attack vs defense quality + form gap + stability + fragility
  const atkDiff = (lamH - lamA) * 10;
  const formDiff = (formH - formA) * 0.6;
  const stabDiff = (stabH - stabA) * 2.0;
  const flexDiff = (flexH - flexA) * 1.5;
  const errDiff = (errA - errH) * 20;  // error defensif lawan tingkatkan difficulty

  const difficultyIndex = atkDiff + formDiff + stabDiff + flexDiff + errDiff;

  let rating = "";
  if(difficultyIndex >= 20) rating = "VERY FAVORABLE for HOME";
  else if(difficultyIndex >= 8) rating = "FAVORABLE for HOME";
  else if(difficultyIndex <= -20) rating = "VERY FAVORABLE for AWAY";
  else if(difficultyIndex <= -8) rating = "FAVORABLE for AWAY";
  else rating = "BALANCED / NEUTRAL";

  PSZ.log("============================================");
  PSZ.log("ðŸ”¥ MATCH DIFFICULTY ENGINE");
  PSZ.log(`Difficulty Index: ${difficultyIndex.toFixed(2)} â†’ ${rating}`);
  PSZ.log("(Positive = Home advantage | Negative = Away advantage)");
};


// ================================
// 2) MATCH FLOW ENGINE
// ================================
PSZ.runMatchFlow = function(){

  const tempo = PSZ.num("tempo_input",5);
  const chaos = PSZ.num("chaos_input",5);
  const pressH = PSZ.num("home_press",5);
  const pressA = PSZ.num("away_press",5);
  const imp = PSZ.num("importance_input",5);

  const formH = PSZ.num("form_home_w")*2.3 - PSZ.num("form_home_l")*1.8;
  const formA = PSZ.num("form_away_w")*2.3 - PSZ.num("form_away_l")*1.8;

  const momH = PSZ.num("home_mom",5);
  const momA = PSZ.num("away_mom",5);

  const momentumFlow = (momH - momA) * 1.4 + (formH - formA)*0.2;
  const pressingFlow = (pressH - pressA) * 1.3;
  const tempoFlow = (tempo - 5) * 1.1;
  const chaosFlow = (chaos - 5) * 0.9;

  const finalFlow = momentumFlow + pressingFlow + tempoFlow + chaosFlow + (imp - 5)*0.4;

  let direction = "";
  if(finalFlow >= 15) direction = "Home Dominating Phase (High Pressure)";
  else if(finalFlow >= 7) direction = "Home Slight Momentum";
  else if(finalFlow <= -15) direction = "Away Dominating Phase";
  else if(finalFlow <= -7) direction = "Away Slight Momentum";
  else direction = "Balanced Flow";

  PSZ.log("============================================");
  PSZ.log("ðŸ”¥ MATCH FLOW ENGINE");
  PSZ.log(`Flow Index: ${finalFlow.toFixed(2)} â†’ ${direction}`);
  PSZ.log("Interpretasi: pergerakan momentum selama pertandingan.");
};


// ================================
// 3) TEAM TREND ENGINE
// ================================
PSZ.runTeamTrend = function(){

  const formH = PSZ.num("form_home_w")*2.3 + PSZ.num("form_home_d")*0.9 - PSZ.num("form_home_l")*1.8;
  const formA = PSZ.num("form_away_w")*2.3 + PSZ.num("form_away_d")*0.9 - PSZ.num("form_away_l")*1.8;

  const momH = PSZ.num("home_mom",5);
  const momA = PSZ.num("away_mom",5);

  const trendH = formH*0.7 + momH*1.2;
  const trendA = formA*0.7 + momA*1.2;

  const diff = trendH - trendA;

  let status = "";
  if(diff >= 8) status = "HOME in STRONG UPTREND";
  else if(diff >= 3) status = "HOME positive trend";
  else if(diff <= -8) status = "AWAY in STRONG UPTREND";
  else if(diff <= -3) status = "AWAY positive trend";
  else status = "NEUTRAL trend";

  PSZ.log("============================================");
  PSZ.log("ðŸ”¥ TEAM TREND ENGINE");
  PSZ.log(`Trend Home: ${trendH.toFixed(2)}, Trend Away: ${trendA.toFixed(2)}`);
  PSZ.log(`Trend Difference â†’ ${diff.toFixed(2)} = ${status}`);
};


// ================================
// 4) SET PIECE POWER ENGINE
// ================================
PSZ.runSetPiece = function(){

  // Kita pakai indikator dasar: xG, pressing, error defensif, fleksibilitas taktik
  const hxg = PSZ.num("adv_xg_home",1.5);
  const axg = PSZ.num("adv_xg_away",1.5);
  const errH = PSZ.num("adv_err_home",0.15);
  const errA = PSZ.num("adv_err_away",0.18);
  const flexH = PSZ.num("home_flex",5);
  const flexA = PSZ.num("away_flex",5);

  // Rumus sederhana namun efektif:
  const spHome = hxg*1.4 + flexH*0.6 - errH*12;
  const spAway = axg*1.4 + flexA*0.6 - errA*12;

  const diff = spHome - spAway;

  let label = "";
  if(diff >= 3) label = "Home Set-Piece Advantage";
  else if(diff >= 1) label = "Home Slight Edge";
  else if(diff <= -3) label = "Away Set-Piece Advantage";
  else if(diff <= -1) label = "Away Slight Edge";
  else label = "Balanced";

  PSZ.log("============================================");
  PSZ.log("ðŸ”¥ SET PIECE POWER ENGINE");
  PSZ.log(`SP Home=${spHome.toFixed(2)}, SP Away=${spAway.toFixed(2)}`);
  PSZ.log(`Difference: ${diff.toFixed(2)} â†’ ${label}`);
};
// ===========================================================
// PART 5 â€“ INFINITY ENGINE & GRAND UNIFIED ENGINE
// ===========================================================

// Helper: hitung probabilitas dasar dari Î» (0â€“6)
PSZ.computeBaseProbs = function(lambdaH, lambdaA, maxG = 6){
  let distH = [];
  let distA = [];
  for(let i=0;i<=maxG;i++){
    distH[i] = PSZ_poisson(i, lambdaH);
    distA[i] = PSZ_poisson(i, lambdaA);
  }
  let pH = 0, pD = 0, pA = 0;
  for(let h=0;h<=maxG;h++){
    for(let a=0;a<=maxG;a++){
      const p = distH[h]*distA[a];
      if(h > a) pH += p;
      else if(h === a) pD += p;
      else pA += p;
    }
  }

  function probOver(total){
    let p = 0;
    for(let h=0;h<=maxG;h++){
      for(let a=0;a<=maxG;a++){
        if(h+a > total) p += distH[h]*distA[a];
      }
    }
    return p;
  }

  const O25 = probOver(2);
  const O35 = probOver(3);

  return {pH,pD,pA,O25,O35};
};

// ================================
// 1) INFINITY ENGINE
// Multi-skenario: Tight, Base, Wild
// ================================
PSZ.INF = function(){
  const lamH = PSZ.state.lamH || 1.2;
  const lamA = PSZ.state.lamA || 1.0;

  const tempo = PSZ.num("tempo_input",5);
  const chaos = PSZ.num("chaos_input",5);

  // Normalisasi 0â€“1
  const tempoN = Math.max(0,Math.min(1,(tempo/10)));
  const chaosN = Math.max(0,Math.min(1,(chaos/10)));

  // Skenario Î»:
  // Tight: tempo & chaos lebih rendah â†’ pertandingan "nge-press tapi rapat"
  const tightH = lamH * (0.95 - 0.10*chaosN);
  const tightA = lamA * (0.95 - 0.10*chaosN);

  // Base: pakai Î» dari PRIME + sedikit pengaruh tempo
  const baseH = lamH * (1 + (tempoN-0.5)*0.10);
  const baseA = lamA * (1 + (tempoN-0.5)*0.10);

  // Wild: tempo & chaos menaikkan volume gol
  const wildFactor = 1 + 0.35*chaosN + 0.15*tempoN;
  const wildH = lamH * wildFactor;
  const wildA = lamA * wildFactor;

  const tight = PSZ.computeBaseProbs(tightH, tightA);
  const base  = PSZ.computeBaseProbs(baseH,  baseA);
  const wild  = PSZ.computeBaseProbs(wildH,  wildA);

  PSZ.log("============================================");
  PSZ.log("âš¡ INFINITY ENGINE â€“ Multi Scenario Analysis");

  PSZ.log(`TIGHT Î»H=${tightH.toFixed(3)}, Î»A=${tightA.toFixed(3)}`);
  PSZ.log(`  H: ${(tight.pH*100).toFixed(2)}%  D: ${(tight.pD*100).toFixed(2)}%  A: ${(tight.pA*100).toFixed(2)}%`);
  PSZ.log(`  O2.5: ${(tight.O25*100).toFixed(2)}%  O3.5: ${(tight.O35*100).toFixed(2)}%`);

  PSZ.log("--------------------------------------------");
  PSZ.log(`BASE Î»H=${baseH.toFixed(3)}, Î»A=${baseA.toFixed(3)} (Prime-context)`);
  PSZ.log(`  H: ${(base.pH*100).toFixed(2)}%  D: ${(base.pD*100).toFixed(2)}%  A: ${(base.pA*100).toFixed(2)}%`);
  PSZ.log(`  O2.5: ${(base.O25*100).toFixed(2)}%  O3.5: ${(base.O35*100).toFixed(2)}%`);

  PSZ.log("--------------------------------------------");
  PSZ.log(`WILD Î»H=${wildH.toFixed(3)}, Î»A=${wildA.toFixed(3)} (High-variance)`);
  PSZ.log(`  H: ${(wild.pH*100).toFixed(2)}%  D: ${(wild.pD*100).toFixed(2)}%  A: ${(wild.pA*100).toFixed(2)}%`);
  PSZ.log(`  O2.5: ${(wild.O25*100).toFixed(2)}%  O3.5: ${(wild.O35*100).toFixed(2)}%`);

  // Simpan sedikit ringkasan ke state (untuk GUN)
  PSZ.state.infinity = {tight,base,wild,tightH,tightA,baseH,baseA,wildH,wildA};
};

// Override tombol INFINITY
PSZ.runInfinity = function(){
  try{
    PSZ.autoCalcRequired(); // pastikan Î» up-to-date
    PSZ.INF();
  }catch(e){
    console.error(e);
    alert("Error INFINITY ENGINE (lihat console).");
  }
};


// ================================
// 2) GRAND UNIFIED ENGINE (GUN)
// Gabungkan:
// - PRIME Î»
// - Infinity scenarios
// - TCI (tempo/chaos)
// - Match Difficulty & Trend approx
// Untuk memberi rekomendasi tipe edge & risk band.
// ================================
PSZ.GUN = function(){

  const lamH = PSZ.state.lamH || 1.2;
  const lamA = PSZ.state.lamA || 1.0;

  const tempo = PSZ.num("tempo_input",5);
  const chaos = PSZ.num("chaos_input",5);
  const imp   = PSZ.num("importance_input",5);

  const pressH = PSZ.num("home_press",5);
  const pressA = PSZ.num("away_press",5);

  const errH = PSZ.num("adv_err_home",0.15);
  const errA = PSZ.num("adv_err_away",0.18);

  // A. Base probabilities (PRIME-style) untuk Î» current
  const base = PSZ.computeBaseProbs(lamH, lamA);
  const pH = base.pH, pD = base.pD, pA = base.pA;

  // B. Difficulty approximation (mirror dari MatchDifficulty, tapi ringkas)
  const formH = PSZ.num("form_home_w")*2.3 + PSZ.num("form_home_d")*0.9 - PSZ.num("form_home_l")*1.8;
  const formA = PSZ.num("form_away_w")*2.3 + PSZ.num("form_away_d")*0.9 - PSZ.num("form_away_l")*1.8;
  const stabH = PSZ.num("home_stab",5);
  const stabA = PSZ.num("away_stab",5);
  const flexH = PSZ.num("home_flex",5);
  const flexA = PSZ.num("away_flex",5);

  const atkDiff = (lamH - lamA) * 10;
  const formDiff = (formH - formA) * 0.5;
  const stabDiff = (stabH - stabA) * 1.8;
  const flexDiff = (flexH - flexA) * 1.2;
  const errDiff = (errA - errH) * 18;

  const difficultyIndex = atkDiff + formDiff + stabDiff + flexDiff + errDiff;

  // C. Flow approximation (mirror dari Match Flow)
  const momH = PSZ.num("home_mom",5);
  const momA = PSZ.num("away_mom",5);

  const momentumFlow = (momH - momA) * 1.4 + (formH - formA)*0.2;
  const pressingFlow = (pressH - pressA) * 1.3;
  const tempoFlow = (tempo - 5) * 1.1;
  const chaosFlow = (chaos - 5) * 0.9;
  const flowIndex = momentumFlow + pressingFlow + tempoFlow + chaosFlow + (imp - 5)*0.4;

  // D. Infinity context (kalau sudah ada di state)
  let wildTilt = null;
  if(PSZ.state.infinity){
    const inf = PSZ.state.infinity;
    // Lihat perbedaan base vs wild untuk side & goals
    const deltaWildGoals = (inf.wild.O25 - inf.base.O25) * 100; // %
    const deltaWildSide  = ((inf.wild.pH - inf.base.pH) - (inf.wild.pA - inf.base.pA))*100;
    wildTilt = {deltaWildGoals, deltaWildSide};
  }

  // E. Klasifikasi Edge
  let edgeType = "Neutral Edge (tidak ada dominasi kuat)";
  let edgeMarket = "Lihat kombinasi 1X2 dan Gol, filter dengan odds.";

  const sideGap = (pH - pA)*100; // % selisih

  if(Math.abs(sideGap) >= 10 && Math.abs(difficultyIndex) >= 10){
    if(sideGap > 0 && difficultyIndex > 0){
      edgeType = "Unified Side Edge â†’ HOME";
      edgeMarket = "Fokus: 1X / Home DNB / Handicap kecil ke Home.";
    } else if(sideGap < 0 && difficultyIndex < 0){
      edgeType = "Unified Side Edge â†’ AWAY";
      edgeMarket = "Fokus: X2 / Away DNB / Handicap kecil ke Away.";
    }
  } else {
    // Kalau side relatif seimbang, lihat goal environment
    const O25 = base.O25*100;
    if(O25 >= 60 && chaos >= 6){
      edgeType = "Unified Goal Edge â†’ High Scoring";
      edgeMarket = "Fokus: Over 2.5 / BTTS / multi-goal pattern.";
    } else if(O25 <= 45 && chaos <= 4){
      edgeType = "Unified Low Goal Edge";
      edgeMarket = "Fokus: Under / draw-ish environment.";
    }
  }

  // F. Risk band: seberapa "gila" match ini
  let riskBand = "Moderate Variance";
  const varScore = chaos*1.3 + Math.abs(pressH - pressA) + (errH+errA)*25;
  if(varScore >= 25) riskBand = "High Variance (fun match, hati-hati stake besar)";
  else if(varScore <= 12) riskBand = "Lowâ€“Moderate Variance (cocok untuk single bet / parlay pendek)";

  // G. Output
  PSZ.log("============================================");
  PSZ.log("ðŸŒŒ GRAND UNIFIED ENGINE (G.U.N.)");
  PSZ.log(`Î»H=${lamH.toFixed(3)}, Î»A=${lamA.toFixed(3)}`);
  PSZ.log(`PRIME Result â†’ H=${(pH*100).toFixed(2)}%  D=${(pD*100).toFixed(2)}%  A=${(pA*100).toFixed(2)}%`);
  PSZ.log(`Difficulty Index: ${difficultyIndex.toFixed(2)}`);
  PSZ.log(`Flow Index: ${flowIndex.toFixed(2)}`);
  if(wildTilt){
    PSZ.log(`Infinity Tilt (Wild vs Base): Goals Î”O2.5=${wildTilt.deltaWildGoals.toFixed(2)} pts, Side tilt=${wildTilt.deltaWildSide.toFixed(2)} pts`);
  }
  PSZ.log("--------------------------------------------");
  PSZ.log(`UNIFIED EDGE: ${edgeType}`);
  PSZ.log(`Market Fokus: ${edgeMarket}`);
  PSZ.log(`Risk Band: ${riskBand}`);
  PSZ.log("G.U.N. selesai â€“ gunakan sebagai ringkasan arah utama sebelum masuk BRM & odds.");
};

// Override tombol GRAND UNIFIED
PSZ.runGrandUnified = function(){
  try{
    // Pastikan PRIME & INFINITY sudah punya Î» & context
    PSZ.autoCalcRequired();
    PSZ.INF();   // update infinity context
    PSZ.GUN();
  }catch(e){
    console.error(e);
    alert("Error GRAND UNIFIED ENGINE (lihat console).");
  }
};
// ===========================================================
// PART 6 â€“ BRM SUITE (BANKROLL, PARLAY HELPER, EDGE CLASSIFIER)
// ===========================================================

// ---------------------------------------------
// Helper â€“ convert odds â†’ implied probability
// ---------------------------------------------
PSZ.oddsToProb = function(odds){
  if(!odds || odds <= 1.00) return null;
  return 1 / odds;
};

// ---------------------------------------------
// Helper â€“ Kelly Criterion
// p = probability win
// q = 1 - p
// b = odds - 1
// ---------------------------------------------
PSZ.kelly = function(prob, odds){
  const p = prob;
  const q = 1 - prob;
  const b = odds - 1;
  const f = (b*p - q) / b;

  if(isNaN(f)) return 0;
  return Math.max(0, Math.min(f, 1));
};

// ====================================================
// 1) BRM â€“ BANKROLL ENGINE
// ====================================================
PSZ.runBRM_Bankroll = function(){

  // Input dari PRIME (pH/pD/pA)
  const lamH = PSZ.state.lamH || 1.2;
  const lamA = PSZ.state.lamA || 1.0;

  // Hitung probabilitas dasar
  const base = PSZ.computeBaseProbs(lamH, lamA);
  const pHome = base.pH;
  const pDraw = base.pD;
  const pAway = base.pA;

  // User odds input
  const oHome = PSZ.num("odds_home", 0);
  const oDraw = PSZ.num("odds_draw", 0);
  const oAway = PSZ.num("odds_away", 0);

  let log = [];
  log.push("===========================================");
  log.push("ðŸ’° BRM â€“ BANKROLL ENGINE");

  function analyzeSide(name, prob, odds){
    if(odds <= 1.01) return;

    const ip = PSZ.oddsToProb(odds);
    const value = prob - ip;
    const k = PSZ.kelly(prob, odds);

    log.push(`-------------------------------------------`);
    log.push(`Market: ${name}`);
    log.push(`Our Prob = ${(prob*100).toFixed(2)}%`);
    log.push(`Book Prob = ${(ip*100).toFixed(2)}%`);
    log.push(`Value = ${(value*100).toFixed(2)} pts`);
    log.push(`Kelly Fraction = ${(k*100).toFixed(2)}%`);
  }

  analyzeSide("Home", pHome, oHome);
  analyzeSide("Draw", pDraw, oDraw);
  analyzeSide("Away", pAway, oAway);

  PSZ.log(log.join("\n"));
};


// ====================================================
// 2) BRM â€“ PARLAY HELPER
// ====================================================
PSZ.runBRM_Parlay = function(){

  const out = [];
  out.push("===========================================");
  out.push("ðŸ“¦ BRM â€“ PARLAY HELPER");

  // Probability list (user memasukkan peluang manual)
  const p1 = PSZ.num("parlay_leg1", 1);
  const p2 = PSZ.num("parlay_leg2", 1);
  const p3 = PSZ.num("parlay_leg3", 1);
  const p4 = PSZ.num("parlay_leg4", 1);

  const valid = [];
  [p1,p2,p3,p4].forEach((p,i)=>{
    if(p > 0 && p <= 1) valid.push(p);
  });

  if(valid.length === 0){
    out.push("Tidak ada leg valid. Isi nilai probabilitas 0â€“1.");
    PSZ.log(out.join("\n"));
    return;
  }

  let combined = 1;
  valid.forEach(p => combined *= p);

  out.push(`Leg count: ${valid.length}`);
  out.push(`Combined probability: ${(combined*100).toFixed(2)}%`);
  out.push(`Fair odds: ${(1/combined).toFixed(2)}`);

  PSZ.log(out.join("\n"));
};


// ====================================================
// 3) BRM â€“ EDGE CLASSIFIER
// ====================================================
PSZ.runBRM_Edge = function(){

  const lamH = PSZ.state.lamH || 1.2;
  const lamA = PSZ.state.lamA || 1.0;

  const base = PSZ.computeBaseProbs(lamH, lamA);
  const pH = base.pH*100;
  const pD = base.pD*100;
  const pA = base.pA*100;

  const tempo = PSZ.num("tempo_input", 5);
  const chaos = PSZ.num("chaos_input", 5);
  const errH = PSZ.num("adv_err_home", 0.15);
  const errA = PSZ.num("adv_err_away", 0.18);

  let classification = "";
  let recommendation = "";

  // RULEBOOK SEDERHANA:
  // 1) Jika selisih side besar + chaos rendah â†’ side edge
  // 2) Jika chaos tinggi + O2.5 besar â†’ goal edge
  // 3) Jika tempo rendah + error rendah â†’ under edge

  // Side gap
  const sideGap = pH - pA;

  // O2.5 baseline
  const O25 = base.O25*100;

  if(Math.abs(sideGap) >= 12 && chaos <= 6){
    if(sideGap > 0){
      classification = "SIDE EDGE â†’ HOME";
      recommendation = "Home DNB / Handicap kecil.";
    } else {
      classification = "SIDE EDGE â†’ AWAY";
      recommendation = "Away DNB / Handicap kecil.";
    }
  }
  else if(O25 >= 60 && chaos >= 6){
    classification = "GOAL EDGE â†’ OVER ENVIRONMENT";
    recommendation = "Over 2.5 / BTTS.";
  }
  else if(O25 <= 45 && tempo <= 4 && (errH+errA) <= 0.32){
    classification = "LOW GOAL EDGE";
    recommendation = "Under market.";
  }
  else {
    classification = "NEUTRAL / MIXED EDGE";
    recommendation = "Hanya ambil market jika odds memberikan value.";
  }

  PSZ.log("===========================================");
  PSZ.log("ðŸ“Š EDGE CLASSIFIER");
  PSZ.log(`SideGap = ${sideGap.toFixed(2)} pts`);
  PSZ.log(`O2.5 = ${O25.toFixed(2)}%`);
  PSZ.log(`Chaos = ${chaos}`);
  PSZ.log("-------------------------------------------");
  PSZ.log(`Classification: ${classification}`);
  PSZ.log(`Recommendation: ${recommendation}`);
};


// ====================================================
// 4) BRM SUITE â€“ COMBO
// ====================================================
PSZ.runBRM_Suite = function(){
  try{
    PSZ.runBRM_Bankroll();
    PSZ.runBRM_Parlay();
    PSZ.runBRM_Edge();
    PSZ.log("BRM SUITE: Semua modul selesai.");
  }catch(e){
    console.error(e);
    alert("Error pada BRM SUITE (lihat console).");
  }
};
// ===========================================================
// PART 7 â€“ UI HELPER, VALIDASI & HIGHLIGHT INPUT
// ===========================================================

// 1) Tambah CSS kecil lewat JS untuk highlight input bermasalah
(function addPSZHighlightCSS(){
  const css = `
    .psz-required-empty{
      border-color: var(--danger) !important;
      box-shadow: 0 0 6px rgba(255,79,129,.8) !important;
    }
  `;
  const styleEl = document.createElement("style");
  styleEl.textContent = css;
  document.head.appendChild(styleEl);
})();

// 2) Daftar input yang dianggap "wajib dianalisis" (bukan wajib isi, tapi penting)
PSZ.requiredFields = [
  "h_gf","h_ga","a_gf","a_ga",
  "adv_xg_home","adv_xga_home","adv_xg_away","adv_xga_away",
  "form_home_w","form_home_d","form_home_l",
  "form_away_w","form_away_d","form_away_l",
  "adv_err_home","adv_err_away",
  "press_style_home","press_style_away"
];

// Fungsi cek & highlight
PSZ.checkRequiredInputs = function(showAlertOnce = true){
  const missing = [];
  PSZ.requiredFields.forEach(id=>{
    const el = PSZ.el(id);
    if(!el) return;
    let isEmpty = false;

    if(el.tagName === "SELECT"){
      if(!el.value || el.value === "") isEmpty = true;
    } else {
      if(el.value === "" || el.value === null){
        isEmpty = true;
      }
    }

    if(isEmpty){
      el.classList.add("psz-required-empty");
      missing.push(id);
    } else {
      el.classList.remove("psz-required-empty");
    }
  });

  if(missing.length > 0){
    PSZ.log("âš  WARNING: Ada input penting yang kosong / belum diisi penuh. Model tetap jalan, tapi akurasi bisa berkurang.");
    PSZ.log(`Kolom yang sebaiknya diisi: ${missing.join(", ")}`);
    if(showAlertOnce){
      alert("Beberapa input penting kosong / belum diisi.\nModel tetap jalan, tapi hasil kurang tajam.\nCek log OUTPUT untuk daftar kolomnya.");
    }
  } else {
    PSZ.log("âœ… Semua input penting sudah terisi (minimal).");
  }
  return missing.length === 0;
};

// 3) Pasang listener untuk live highlight ketika user mengetik
PSZ.initHighlightListeners = function(){
  PSZ.requiredFields.forEach(id=>{
    const el = PSZ.el(id);
    if(!el) return;
    el.addEventListener("input", ()=>{
      if(el.value === "" || el.value === null){
        el.classList.add("psz-required-empty");
      } else {
        el.classList.remove("psz-required-empty");
      }
    });
  });
};

// 4) Override sedikit runPrimeZero agar selalu cek & beri warning,
//    tapi TIDAK menghentikan engine (hanya peringatan).
const PSZ_runPrimeZero_old = PSZ.runPrimeZero;
PSZ.runPrimeZero = function(){
  try{
    PSZ.checkRequiredInputs(true);  // beri warning jika ada yang kosong
  }catch(e){
    console.warn("PSZ.checkRequiredInputs error (abaikan):", e);
  }
  // tetap jalankan engine lama
  PSZ_runPrimeZero_old();
};

// 5) Jalankan init highlight setelah DOM siap (tambahan kecil)
document.addEventListener("DOMContentLoaded", function(){
  try{
    PSZ.initHighlightListeners();
    PSZ.log("UI Helper: highlight & warning input aktif (PART 7).");
  }catch(e){
    console.warn("Init highlight error:", e);
  }
});
</script>
</body>
</html>

